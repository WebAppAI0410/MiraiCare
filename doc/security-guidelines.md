# MiraiCare セキュリティガイドライン

## 概要
MiraiCareは高齢者の健康データを扱うため、セキュリティとプライバシー保護を最優先に設計されています。

## セキュリティ原則

### 1. 最小権限の原則
- ユーザーは自分のデータのみアクセス可能
- 各操作に必要な最小限の権限のみ付与
- 管理者権限は現在無効化

### 2. データの完全性
- バイタルデータとムードデータは不変（削除・改ざん不可）
- タイムスタンプの検証により、データの時系列を保証
- Cloud Functionsによる自動処理でデータの一貫性を維持

### 3. アクセス制御

#### ユーザーコレクション (`/users/{userId}`)
- **読み取り**: 本人のみ
- **作成**: 本人のみ（必須フィールドの検証あり）
- **更新**: 本人のみ（ユーザーIDは変更不可）
- **削除**: 不可（Cloud Functionsでのみ実行）

#### バイタルデータ (`/vitalData/{docId}`)
- **読み取り**: データ所有者のみ
- **作成**: 本人のデータのみ（数値範囲の検証あり）
- **更新**: 本人のデータのみ（ユーザーID変更不可）
- **削除**: 不可

#### ムードデータ (`/moodData/{docId}`)
- **読み取り**: データ所有者のみ
- **作成**: 本人のデータのみ（有効な気分値のみ）
- **更新**: 不可（不変データ）
- **削除**: 不可

#### リマインダー (`/reminders/{reminderId}`)
- **読み取り**: 本人のデータのみ
- **作成**: 本人のデータのみ（タイプ検証あり）
- **更新**: 完了状態のみ変更可能
- **削除**: 本人のデータのみ

#### バッジ (`/badges/{badgeId}`)
- **読み取り**: 本人のバッジのみ
- **作成/更新/削除**: Cloud Functionsでのみ実行

#### 通知 (`/notifications/{notificationId}`)
- **読み取り**: 本人の通知のみ
- **作成**: Cloud Functionsでのみ実行
- **更新**: 既読フラグのみ変更可能
- **削除**: 本人の通知のみ

## データ検証ルール

### バイタルデータ
- 歩数: 0以上の整数
- 心拍数: 40-200の範囲内の整数
- タイムスタンプ: 必須

### ムードデータ
- 気分: 定義された5段階の値のみ
  - `very_happy`, `happy`, `neutral`, `sad`, `very_sad`
- タイムスタンプ: 必須

### リマインダー
- タイプ: `water`（水分補給）または`medication`（服薬）
- スケジュール時刻: 文字列形式
- 完了状態: ブール値

## Cloud Functions セキュリティ

### 実行権限
- デイリーレポート: スケジュール実行（毎日20時）
- バッジチェック: データ作成時にトリガー
- リマインダー通知: 5分ごとにスケジュール実行
- ユーザーデータクリーンアップ: 認証削除時にトリガー

### データアクセス
- Admin SDKを使用してセキュアにデータベースアクセス
- ユーザー権限を超えた操作が必要な場合のみ使用

## プライバシー保護

### 個人情報の取り扱い
- 健康データは本人以外アクセス不可
- 通知トークンは暗号化して保存
- ログには個人を特定できる情報を含めない

### データ保持
- ユーザー削除時に関連データを完全削除
- バックアップは暗号化して保存
- 最小限の期間のみデータを保持

## ベストプラクティス

### 開発者向け
1. 新機能追加時は必ずセキュリティルールを更新
2. クライアントサイドでの入力検証も実装
3. エラーメッセージに機密情報を含めない
4. 定期的なセキュリティ監査の実施

### 運用時の注意
1. Firebase Authenticationの設定を定期的に確認
2. 異常なアクセスパターンの監視
3. セキュリティアラートへの迅速な対応
4. 定期的なバックアップとリストアテスト

## インシデント対応

### 発生時の手順
1. 影響範囲の特定
2. 必要に応じてアクセス制限
3. ログの確認と原因究明
4. 対策の実施と再発防止

### 連絡先
- セキュリティインシデント: security@miraicare.example.com
- 技術サポート: support@miraicare.example.com

## 更新履歴
- 2025-05-27: 初版作成
- Firebase統合に伴うセキュリティルール全面改定