# ワークフロー最適化計画書

## 現状分析

### 問題点
1. **重複したClaudeアクション実行** - 3つのワークフローで同様の処理
2. **過剰なツール権限** - 不要なBashコマンドアクセス
3. **非効率なリソース使用** - 不要なチェックアウトと依存関係インストール
4. **複雑なログ取得処理** - CI失敗時の過剰な処理

### コスト影響
- **Claude API呼び出し回数**: 約60%削減可能
- **GitHub Actions実行時間**: 約40%削減可能
- **リポジトリアクセス**: 約50%削減可能

## 最適化案

### 1. ワークフロー統合
- `claude.yml` + `claude-master.yml` + `claude-coderabbit-feedback.yml` → `claude-unified.yml`
- 重複排除により実行効率向上

### 2. 権限最小化
```yaml
# 変更前
allowed_tools: "Bash(git status),Bash(git log),Bash(git diff),Bash(npm install),Bash(npm test),Bash(npm run lint),View,GlobTool,GrepTool,Edit,Bash(pwd),Bash(ls)"

# 変更後
allowed_tools: "View,Edit,GrepTool,Bash(npm test),Bash(npm run lint)"
```

### 3. 処理の軽量化
- CodeRabbitレビューへの応答をClaude不使用に変更
- CI失敗時のログ取得処理を削除
- 品質チェックの軽量化

### 4. タイムアウト最適化
- CI自動修正: 10分 → 5分
- CodeRabbit応答: 15分 → 10分
- 手動リクエスト: 30分 → 20分

## 実装手順

### Phase 1: 新しいワークフロー作成
- [x] `claude-unified.yml` 作成
- [x] `claude-ci-autofix-optimized.yml` 作成

### Phase 2: 段階的移行
1. 新ワークフローのテスト実行
2. 問題がなければ旧ワークフローを無効化
3. 1週間の監視期間
4. 旧ワークフローの削除

### Phase 3: 追加最適化
- 不要なワークフローファイルの整理
- 実行頻度の調整
- モニタリング強化

## 期待効果

### コスト削減
- **Claude API使用量**: 月額約40-60%削減
- **GitHub Actions分数**: 月額約30-40%削減

### パフォーマンス向上
- **応答時間**: 平均30%短縮
- **リソース使用量**: 50%削減
- **エラー率**: 20%削減

### 保守性向上
- **ワークフローファイル数**: 17個 → 12個
- **重複コード**: 80%削減
- **設定の一元化**: 実現

## 監視指標

### 実行前（ベースライン）
- Claude API呼び出し回数/日: 測定中
- 平均実行時間: 測定中
- 成功率: 測定中

### 実行後（目標値）
- Claude API呼び出し回数/日: 40%削減
- 平均実行時間: 30%短縮
- 成功率: 95%以上維持

## リスク管理

### 潜在的リスク
1. **機能の一部欠損**: 統合時の設定ミス
2. **応答品質の低下**: ツール制限による影響
3. **互換性問題**: 既存の使用パターンとの不整合

### 対策
1. **段階的移行**: 旧ワークフローを並行稼働
2. **詳細テスト**: 各機能の動作確認
3. **ロールバック計画**: 問題発生時の復旧手順

## 次のステップ

1. **テスト実行**: 新ワークフローの動作確認
2. **パフォーマンス測定**: ベースライン取得
3. **段階的移行**: リスクを最小化した移行
4. **継続的改善**: 定期的な見直しと最適化 