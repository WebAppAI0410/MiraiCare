name: Enhanced Workflow Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # 6æ™‚é–“ã”ã¨
  workflow_dispatch:
    inputs:
      force_full_check:
        description: 'å®Œå…¨è¨ºæ–­ã‚’å¼·åˆ¶å®Ÿè¡Œ'
        required: false
        default: false
        type: boolean

jobs:
  enhanced-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      issues: write
      actions: read
      pull-requests: read

    steps:
      - uses: actions/checkout@v4

      - name: Comprehensive Workflow Analysis
        id: analysis
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // 1. æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®šç¾©
            const expectedBehaviors = {
              'claude_code_actions': {
                trigger: '@claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³',
                expected_within: '5åˆ†ä»¥å†…',
                check_condition: 'Issue/PRæœ¬æ–‡ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã«@claudeãŒã‚ã‚‹å ´åˆ'
              },
              'pr_auto_creation': {
                trigger: 'claude/issue-* ãƒ–ãƒ©ãƒ³ãƒä½œæˆ',
                expected_within: '10åˆ†ä»¥å†…', 
                check_condition: 'claude/issue-*ãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ãŒPRãŒæœªä½œæˆ'
              },
              'auto_error_detection': {
                trigger: 'mainãƒ–ãƒ©ãƒ³ãƒpush',
                expected_within: '15åˆ†ä»¥å†…',
                check_condition: 'mainãƒ–ãƒ©ãƒ³ãƒã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹ãŒIssueæœªä½œæˆ'
              }
            };

            // 2. ç¾åœ¨ã®çŠ¶æ³ã‚’åˆ†æ
            const now = new Date();
            const sixHoursAgo = new Date(now.getTime() - 6 * 60 * 60 * 1000);
            
            let analysisReport = {
              missing_behaviors: [],
              delayed_behaviors: [],
              unexpected_behaviors: [],
              health_score: 100
            };

            // 3. @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹Issue/PRã§Claude Code ActionsãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„ã‚±ãƒ¼ã‚¹ã‚’æ¤œå‡º
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              since: sixHoursAgo.toISOString()
            });

            for (const issue of issues.data) {
              const hasClaudeMention = issue.body && issue.body.includes('@claude');
              
              if (hasClaudeMention) {
                // Claude Code Actionsã®å®Ÿè¡Œå±¥æ­´ã‚’ç¢ºèª
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'claude.yml',
                  created: `>=${issue.created_at}`
                });
                
                const relatedRun = runs.data.workflow_runs.find(run => 
                  run.event === 'issues' && 
                  Math.abs(new Date(run.created_at) - new Date(issue.created_at)) < 10 * 60 * 1000
                );
                
                if (!relatedRun) {
                  analysisReport.missing_behaviors.push({
                    type: 'claude_code_actions_missing',
                    issue_number: issue.number,
                    issue_title: issue.title,
                    created_at: issue.created_at,
                    description: `Issue #${issue.number}ã«@claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ãŒClaude Code ActionsãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„`
                  });
                  analysisReport.health_score -= 15;
                }
              }
            }

            // 4. claude/issue-*ãƒ–ãƒ©ãƒ³ãƒã§PRæœªä½œæˆã®ã‚±ãƒ¼ã‚¹ã‚’æ¤œå‡º
            const branches = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const claudeBranches = branches.data.filter(branch => 
              branch.name.startsWith('claude/issue-')
            );

            for (const branch of claudeBranches) {
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch.name}`,
                state: 'all'
              });

              if (prs.data.length === 0) {
                // ãƒ–ãƒ©ãƒ³ãƒä½œæˆã‹ã‚‰10åˆ†ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆ
                const branchAge = now - new Date(branch.commit.commit.author.date);
                if (branchAge > 10 * 60 * 1000) {
                  analysisReport.missing_behaviors.push({
                    type: 'pr_auto_creation_missing',
                    branch_name: branch.name,
                    created_at: branch.commit.commit.author.date,
                    description: `ãƒ–ãƒ©ãƒ³ãƒ ${branch.name} ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ãŒPRãŒè‡ªå‹•ä½œæˆã•ã‚Œã¦ã„ãªã„`
                  });
                  analysisReport.health_score -= 10;
                }
              }
            }

            // 5. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
            const workflowRuns = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              created: `>=${sixHoursAgo.toISOString()}`
            });

            // åŒä¸€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ç•°å¸¸ãªå®Ÿè¡Œé »åº¦ã‚’æ¤œå‡º
            const workflowCounts = {};
            for (const run of workflowRuns.data.workflow_runs) {
              const workflowName = run.name;
              workflowCounts[workflowName] = (workflowCounts[workflowName] || 0) + 1;
            }

            for (const [workflowName, count] of Object.entries(workflowCounts)) {
              if (count > 20) { // 6æ™‚é–“ã§20å›ä»¥ä¸Šã¯ç•°å¸¸
                analysisReport.unexpected_behaviors.push({
                  type: 'excessive_workflow_runs',
                  workflow_name: workflowName,
                  run_count: count,
                  description: `${workflowName}ãŒ6æ™‚é–“ã§${count}å›å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ï¼ˆç•°å¸¸ãªé »åº¦ï¼‰`
                });
                analysisReport.health_score -= 20;
              }
            }

            // 6. çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            fs.writeFileSync('workflow-analysis.json', JSON.stringify(analysisReport, null, 2));
            
            // 7. å‡ºåŠ›è¨­å®š
            core.setOutput('health_score', analysisReport.health_score);
            core.setOutput('has_issues', analysisReport.health_score < 80);
            core.setOutput('missing_count', analysisReport.missing_behaviors.length);
            core.setOutput('delayed_count', analysisReport.delayed_behaviors.length);
            
            console.log('Enhanced workflow analysis completed');
            console.log(`Health Score: ${analysisReport.health_score}`);
            console.log(`Missing Behaviors: ${analysisReport.missing_behaviors.length}`);
            console.log(`Delayed Behaviors: ${analysisReport.delayed_behaviors.length}`);
            console.log(`Unexpected Behaviors: ${analysisReport.unexpected_behaviors.length}`);

      - name: Create Enhanced Monitoring Issue
        if: steps.analysis.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysisReport = JSON.parse(fs.readFileSync('workflow-analysis.json', 'utf8'));
            
            // æ—¢å­˜ã®ç›£è¦–Issueã‚’ãƒã‚§ãƒƒã‚¯
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-monitor,enhanced'
            });

            let issueBody = [
              '## ğŸ” æ‹¡å¼µãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ',
              '',
              `**å¥å…¨æ€§ã‚¹ã‚³ã‚¢**: ${analysisReport.health_score}/100`,
              `**æ¤œå‡ºæ—¥æ™‚**: ${new Date().toISOString()}`,
              ''
            ];

            if (analysisReport.missing_behaviors.length > 0) {
              issueBody.push('### âŒ æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„å•é¡Œ');
              for (const behavior of analysisReport.missing_behaviors) {
                issueBody.push(`- **${behavior.type}**: ${behavior.description}`);
                if (behavior.issue_number) {
                  issueBody.push(`  - å¯¾è±¡Issue: #${behavior.issue_number}`);
                }
                if (behavior.branch_name) {
                  issueBody.push(`  - å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ: ${behavior.branch_name}`);
                }
                issueBody.push(`  - ç™ºç”Ÿæ™‚åˆ»: ${behavior.created_at}`);
                issueBody.push('');
              }
            }

            if (analysisReport.delayed_behaviors.length > 0) {
              issueBody.push('### â° é…å»¶ã—ã¦ã„ã‚‹å‹•ä½œ');
              for (const behavior of analysisReport.delayed_behaviors) {
                issueBody.push(`- **${behavior.type}**: ${behavior.description}`);
              }
              issueBody.push('');
            }

            if (analysisReport.unexpected_behaviors.length > 0) {
              issueBody.push('### ğŸš¨ ç•°å¸¸ãªå‹•ä½œãƒ‘ã‚¿ãƒ¼ãƒ³');
              for (const behavior of analysisReport.unexpected_behaviors) {
                issueBody.push(`- **${behavior.type}**: ${behavior.description}`);
              }
              issueBody.push('');
            }

            issueBody.push('### ğŸ”§ æ¨å¥¨å¯¾å¿œ');
            issueBody.push('- [ ] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ¡ä»¶ã®ç¢ºèª');
            issueBody.push('- [ ] æ¨©é™è¨­å®šã®ç¢ºèª');
            issueBody.push('- [ ] ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ã®è¦‹ç›´ã—');
            issueBody.push('- [ ] GitHub Actionsåˆ¶é™ã®ç¢ºèª');
            issueBody.push('');
            issueBody.push('---');
            issueBody.push('*æ‹¡å¼µãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆ*');
            issueBody.push('');
            issueBody.push('@claude [sonnet] ä¸Šè¨˜ã®å•é¡Œã‚’åˆ†æã—ã€ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚');

            if (existingIssues.data.length > 0) {
              // æ—¢å­˜Issueã‚’æ›´æ–°
              const issue = existingIssues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: issueBody.join('\n')
              });
              console.log(`æ—¢å­˜ç›£è¦–Issue #${issue.number} ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
            } else {
              // æ–°ã—ã„Issueã‚’ä½œæˆ
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ” [ENHANCED] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å‹•ä½œç•°å¸¸æ¤œå‡º - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody.join('\n'),
                labels: ['workflow-monitor', 'enhanced', 'bug', 'urgent']
              });
              
              console.log(`æ‹¡å¼µç›£è¦–Issue #${issue.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ`);
            }

      - name: Success Report
        if: steps.analysis.outputs.has_issues == 'false'
        run: |
          echo "âœ… æ‹¡å¼µãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç›£è¦–: å…¨ã¦ã®æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™"
          echo "å¥å…¨æ€§ã‚¹ã‚³ã‚¢: ${{ steps.analysis.outputs.health_score }}/100" 