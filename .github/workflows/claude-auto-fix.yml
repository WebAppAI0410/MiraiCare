name: Claude Auto Fix

on:
  pull_request:
    types: [opened, synchronize]
  workflow_run:
    workflows: ["RN Unit CI"]
    types: [completed]

jobs:
  auto-fix-ci-failures:
    # CIå¤±æ•—æ™‚ã¾ãŸã¯PRæ›´æ–°æ™‚ã«è‡ªå‹•ä¿®æ­£
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR details
        id: pr_details
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber, headRef;
            
            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
              headRef = context.payload.pull_request.head.ref;
            } else if (context.eventName === 'workflow_run') {
              // workflow_runã®å ´åˆã€é–¢é€£ã™ã‚‹PRã‚’æ¤œç´¢
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });
              
              const pr = prs.data.find(pr => 
                pr.head.ref.startsWith('claude/issue-') || 
                pr.title.includes('Claudeå®Ÿè£…')
              );
              
              if (pr) {
                prNumber = pr.number;
                headRef = pr.head.ref;
              }
            }
            
            core.setOutput('pr_number', prNumber);
            core.setOutput('head_ref', headRef);
            
            return { prNumber, headRef };

      - name: Check CI status
        id: ci_status
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.pr_details.outputs.pr_number }}';
            if (!prNumber) return;
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const failedChecks = checks.check_runs.filter(check => 
              check.conclusion === 'failure' && 
              (check.name.includes('test') || check.name.includes('lint'))
            );
            
            core.setOutput('has_failures', failedChecks.length > 0);
            core.setOutput('failed_checks', JSON.stringify(failedChecks.map(c => c.name)));
            
            return failedChecks;

      - name: Trigger Claude Code Actions for CI fixes
        if: steps.ci_status.outputs.has_failures == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.pr_details.outputs.pr_number }}';
            const failedChecks = '${{ steps.ci_status.outputs.failed_checks }}';
            
            if (!prNumber) return;
            
            const commentBody = `@claude CIå¤±æ•—ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„\\n\\n## ğŸš¨ CIå¤±æ•—ã®è©³ç´°\\nå¤±æ•—ã—ãŸãƒã‚§ãƒƒã‚¯: ${failedChecks}\\n\\n## ğŸ“‹ ä¿®æ­£ãŒå¿…è¦ãªé …ç›®\\n- [ ] TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£\\n- [ ] ä¸è¶³ã—ã¦ã„ã‚‹ä¾å­˜é–¢ä¿‚ã®è¿½åŠ \\n- [ ] ESLintã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£\\n- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ä¿®æ­£\\n\\n## ğŸ¯ TDDã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã®ä¿®æ­£æ‰‹é †\\n1. **Red**: å¤±æ•—ã—ã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆã‚’ç‰¹å®š\\n2. **Green**: æœ€å°é™ã®ä¿®æ­£ã§ãƒ†ã‚¹ãƒˆã‚’é€šã™\\n3. **Refactor**: ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’å‘ä¸Š\\n\\nä»¥ä¸‹ã®ä¾å­˜é–¢ä¿‚ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š\\n- \\`@testing-library/react-native\\`\\n- \\`@types/jest\\`\\n- \\`jest-expo\\`\\n- \\`zustand\\`\\n- \\`@supabase/supabase-js\\`\\n- \\`@react-native-async-storage/async-storage\\`\\n\\npackage.jsonã«è¿½åŠ ã—ã€TypeScriptã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });

      - name: Wait for Claude response
        if: steps.ci_status.outputs.has_failures == 'true'
        run: |
          echo "Claude Code Actionsã«è‡ªå‹•ä¿®æ­£ã‚’è¦æ±‚ã—ã¾ã—ãŸ"
          echo "PR #${{ steps.pr_details.outputs.pr_number }} ã§ä¿®æ­£ãŒå®Ÿè¡Œã•ã‚Œã¾ã™" 