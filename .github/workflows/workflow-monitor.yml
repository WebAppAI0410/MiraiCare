name: Workflow Monitor

on:
  schedule:
    - cron: '0 6,18 * * *'  # æ¯æ—¥6æ™‚ãƒ»18æ™‚ï¼ˆJST 15æ™‚ãƒ»3æ™‚ï¼‰
  workflow_dispatch:
    inputs:
      force_full_check:
        description: 'å®Œå…¨è¨ºæ–­ã‚’å¼·åˆ¶å®Ÿè¡Œ'
        required: false
        default: false
        type: boolean

jobs:
  unified-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: workflow-monitor
      cancel-in-progress: true
    permissions:
      contents: read
      issues: write
      actions: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Comprehensive workflow analysis
        id: analysis
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = [
              { name: 'claude-unified-fix.yml', displayName: 'Claude Unified Fix', critical: true },
              { name: 'auto-error-detection.yml', displayName: 'Auto Error Detection', critical: true },
              { name: 'test.yml', displayName: 'RN Unit CI', critical: true },
              { name: 'claude.yml', displayName: 'Claude Code Actions', critical: false },
              { name: 'health-check.yml', displayName: 'Project Health Check', critical: false }
            ];
            
            let report = {
              summary: { total: 0, working: 0, issues: 0, warnings: 0 },
              critical_issues: [],
              warnings: [],
              cost_analysis: { total_runs: 0, failed_runs: 0, total_minutes: 0 }
            };
            
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);
            
            for (const workflow of workflows) {
              report.summary.total++;
              
              try {
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow.name,
                  per_page: 20,
                  created: `>${yesterday.toISOString()}`
                });
                
                const totalRuns = runs.data.workflow_runs.length;
                const failedRuns = runs.data.workflow_runs.filter(run => run.conclusion === 'failure').length;
                const successRuns = runs.data.workflow_runs.filter(run => run.conclusion === 'success').length;
                
                // å®Ÿè¡Œæ™‚é–“è¨ˆç®—
                const totalMinutes = runs.data.workflow_runs.reduce((sum, run) => {
                  if (run.updated_at && run.created_at) {
                    return sum + (new Date(run.updated_at) - new Date(run.created_at)) / (1000 * 60);
                  }
                  return sum;
                }, 0);
                
                report.cost_analysis.total_runs += totalRuns;
                report.cost_analysis.failed_runs += failedRuns;
                report.cost_analysis.total_minutes += totalMinutes;
                
                // å•é¡Œæ¤œçŸ¥
                const failureRate = totalRuns > 0 ? failedRuns / totalRuns : 0;
                
                if (workflow.critical && failureRate > 0.5 && totalRuns > 2) {
                  report.critical_issues.push(`ğŸ”´ ${workflow.displayName}: é‡è¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å¤±æ•—ç‡ãŒé«˜ã„ (${Math.round(failureRate*100)}%)`);
                  report.summary.issues++;
                } else if (failureRate > 0.3 && totalRuns > 3) {
                  report.warnings.push(`ğŸŸ¡ ${workflow.displayName}: å¤±æ•—ç‡ãŒé«˜ã„ (${Math.round(failureRate*100)}%)`);
                  report.summary.warnings++;
                } else if (totalRuns > 0) {
                  report.summary.working++;
                }
                
                // æš´èµ°æ¤œçŸ¥ï¼ˆ1æ™‚é–“ã§10å›ä»¥ä¸Šï¼‰
                const recentRuns = runs.data.workflow_runs.filter(run => 
                  new Date(run.created_at) > new Date(Date.now() - 60 * 60 * 1000)
                );
                
                if (recentRuns.length > 10) {
                  report.critical_issues.push(`ğŸš¨ ${workflow.displayName}: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æš´èµ° (1æ™‚é–“ã§${recentRuns.length}å›å®Ÿè¡Œ)`);
                }
                
                // é•·æ™‚é–“å®Ÿè¡Œè­¦å‘Š
                if (totalMinutes > 60 && totalRuns > 0) {
                  report.warnings.push(`â±ï¸ ${workflow.displayName}: å®Ÿè¡Œæ™‚é–“ãŒé•·ã„ (å¹³å‡${Math.round(totalMinutes/totalRuns)}åˆ†)`);
                }
                
                console.log(`${workflow.displayName}: ${totalRuns}å›å®Ÿè¡Œ, ${failedRuns}å›å¤±æ•—, ${Math.round(totalMinutes)}åˆ†`);
                
              } catch (error) {
                if (workflow.critical) {
                  report.critical_issues.push(`âŒ ${workflow.displayName}: ç›£è¦–ã‚¨ãƒ©ãƒ¼ - ${error.message}`);
                  report.summary.issues++;
                } else {
                  report.warnings.push(`âš ï¸ ${workflow.displayName}: ç›£è¦–ã‚¨ãƒ©ãƒ¼ - ${error.message}`);
                  report.summary.warnings++;
                }
              }
            }
            
            // ã‚³ã‚¹ãƒˆåˆ†æ
            const estimatedCost = report.cost_analysis.total_minutes * 0.008;
            const healthScore = Math.round((report.summary.working / report.summary.total) * 100);
            
            core.setOutput('health_score', healthScore);
            core.setOutput('has_critical_issues', report.critical_issues.length > 0);
            core.setOutput('estimated_cost', estimatedCost.toFixed(3));
            core.setOutput('total_runs', report.cost_analysis.total_runs);
            
            console.log(`å¥å…¨æ€§ã‚¹ã‚³ã‚¢: ${healthScore}%`);
            console.log(`æ¨å®šã‚³ã‚¹ãƒˆ: $${estimatedCost.toFixed(3)}`);
            
            return report;

      - name: Create monitoring report (if issues found)
        if: steps.analysis.outputs.has_critical_issues == 'true' || github.event.inputs.force_full_check == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const report = ${{ steps.analysis.outputs.result }};
            const healthScore = '${{ steps.analysis.outputs.health_score }}';
            const estimatedCost = '${{ steps.analysis.outputs.estimated_cost }}';
            const totalRuns = '${{ steps.analysis.outputs.total_runs }}';
            
            const reportBody = `## ğŸ” ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ\\n\\n### ğŸ“Š æ¦‚è¦\\n- **å¥å…¨æ€§ã‚¹ã‚³ã‚¢**: ${healthScore}%\\n- **24æ™‚é–“ã®å®Ÿè¡Œå›æ•°**: ${totalRuns}å›\\n- **æ¨å®šã‚³ã‚¹ãƒˆ**: $${estimatedCost}\\n- **é‡è¦ãªå•é¡Œ**: ${report.critical_issues.length}å€‹\\n- **è­¦å‘Š**: ${report.warnings.length}å€‹\\n\\n${report.critical_issues.length > 0 ? '### ğŸš¨ é‡è¦ãªå•é¡Œ\\n' + report.critical_issues.map(issue => `- ${issue}`).join('\\n') + '\\n\\n**å³åº§ã«å¯¾å¿œãŒå¿…è¦ã§ã™ï¼**\\n\\n' : ''}${report.warnings.length > 0 ? '### âš ï¸ è­¦å‘Š\\n' + report.warnings.map(warning => `- ${warning}`).join('\\n') + '\\n\\n' : ''}### ğŸ’° ã‚³ã‚¹ãƒˆåˆ†æ\\n- ç·å®Ÿè¡Œæ™‚é–“: ${Math.round(report.cost_analysis.total_minutes)}åˆ†\\n- å¤±æ•—ã«ã‚ˆã‚‹ç„¡é§„: ${report.cost_analysis.failed_runs}å›\\n- åŠ¹ç‡åŒ–ã®ä½™åœ°: ${report.cost_analysis.failed_runs > 0 ? 'æœ‰ã‚Š' : 'ç„¡ã—'}\\n\\n### ğŸ”§ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\\n${report.critical_issues.length > 0 ? '- [ ] é‡è¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ç·Šæ€¥ä¿®æ­£\\n' : ''}${report.cost_analysis.total_minutes > 300 ? '- [ ] å®Ÿè¡Œæ™‚é–“ã®æœ€é©åŒ–\\n' : ''}${report.cost_analysis.failed_runs > 10 ? '- [ ] å¤±æ•—ç‡ã®æ”¹å–„\\n' : ''}- [ ] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šã®è¦‹ç›´ã—\\n- [ ] ä¸è¦ãªå®Ÿè¡Œã®å‰Šæ¸›\\n\\n---\\n*æœ€é©åŒ–ã•ã‚ŒãŸç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  - 12æ™‚é–“ã”ã¨å®Ÿè¡Œ*`;

            // æ—¢å­˜ã®ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
            const existingReports = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'workflow-monitor',
              state: 'open'
            });

            const today = new Date().toISOString().split('T')[0];
            const existingToday = existingReports.data.find(issue => 
              issue.title.includes('ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç›£è¦–') && 
              issue.title.includes(today)
            );

            if (!existingToday) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[monitor] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ - ${today}`,
                body: reportBody,
                labels: ['workflow-monitor', 'auto-detected', report.critical_issues.length > 0 ? 'urgent' : 'low-priority']
              });
              
              console.log('ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
            } else {
              console.log('ä»Šæ—¥ã®ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
            }

      - name: Auto-optimization suggestions
        if: steps.analysis.outputs.estimated_cost > 2.0
        uses: actions/github-script@v7
        with:
          script: |
            console.log('âš ï¸ é«˜ã‚³ã‚¹ãƒˆæ¤œå‡º: è‡ªå‹•æœ€é©åŒ–ã‚’ææ¡ˆã—ã¾ã™');
            
            const suggestions = [
              'å®Ÿè¡Œé »åº¦ã®å‰Šæ¸›ï¼ˆ30åˆ†â†’1æ™‚é–“ï¼‰',
              'timeoutè¨­å®šã®çŸ­ç¸®',
              'ä¸è¦ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ç„¡åŠ¹åŒ–',
              'concurrencyè¨­å®šã®è¿½åŠ ',
              'æ¡ä»¶åˆ†å²ã®æœ€é©åŒ–'
            ];
            
            console.log('æœ€é©åŒ–ææ¡ˆ:');
            suggestions.forEach(suggestion => console.log(`- ${suggestion}`));

      - name: Success notification
        if: steps.analysis.outputs.has_critical_issues == 'false' && steps.analysis.outputs.health_score >= 80
        run: |
          echo "âœ… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™"
          echo "å¥å…¨æ€§ã‚¹ã‚³ã‚¢: ${{ steps.analysis.outputs.health_score }}%"
          echo "æ¨å®šã‚³ã‚¹ãƒˆ: $${{ steps.analysis.outputs.estimated_cost }}" 