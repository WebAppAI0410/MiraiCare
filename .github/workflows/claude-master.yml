name: Claude Admin Tools

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: 'å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        default: 'run_quality_check' # quality_check ã‹ã‚‰ run_quality_check ã«å¤‰æ›´
        type: choice
        options:
          - run_claude_autofix
          - run_quality_check

jobs:
  # claude-dispatcher ã¯ä¸è¦ã«ãªã‚‹ãŸã‚å‰Šé™¤

  # auto-fix-handler ã‚’ run_claude_autofix ã«ãƒªãƒãƒ¼ãƒ ã—ã€ç›´æ¥ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒå…¥åŠ›ã‚’å‚ç…§
  run_claude_autofix:
    if: github.event.inputs.action_type == 'run_claude_autofix'
    runs-on: ubuntu-latest
    timeout-minutes: 12
    permissions:
      contents: write
      issues: write # Issueã‚„PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1 # æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Quality analysis for auto-fix
        id: analysis_for_fix
        run: |
          echo "=== å“è³ªåˆ†æ (è‡ªå‹•ä¿®æ­£ç›®çš„) ===" | tee analysis.txt
          echo "typescript_errors=false" >> $GITHUB_OUTPUT
          if ! npx tsc --noEmit --project tsconfig.json 2>&1 | tee -a analysis.txt; then echo "typescript_errors=true" >> $GITHUB_OUTPUT; fi
          echo "eslint_errors=false" >> $GITHUB_OUTPUT
          if ! npm run lint 2>&1 | tee -a analysis.txt; then echo "eslint_errors=true" >> $GITHUB_OUTPUT; fi
          echo "test_errors=false" >> $GITHUB_OUTPUT
          if ! npm test 2>&1 | tee -a analysis.txt; then echo "test_errors=true" >> $GITHUB_OUTPUT; fi

      - name: Claude Auto-Fix Task
        if: steps.analysis_for_fix.outputs.typescript_errors == 'true' || steps.analysis_for_fix.outputs.eslint_errors == 'true' || steps.analysis_for_fix.outputs.test_errors == 'true'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          timeout_minutes: "10"
          allowed_tools: "Edit,View,GrepTool,Bash(npm test)"
          custom_instructions: |
            é–‹ç™ºè€…ã‹ã‚‰ã®æ‰‹å‹•å®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™ã€‚
            ä»¥ä¸‹ã®å“è³ªåˆ†æçµæœã«åŸºã¥ã„ã¦ã€ã‚³ãƒ¼ãƒ‰ã®è‡ªå‹•ä¿®æ­£ã‚’è©¦ã¿ã¦ãã ã•ã„ã€‚
            ```
            ${{ steps.analysis_for_fix.outputs.analysis_output }} # analysis.txt ã®å†…å®¹ã‚’æ¸¡ã™æƒ³å®šã ãŒã€ç›´æ¥ã¯é›£ã—ã„
            ```
            åˆ†æçµæœã®è©³ç´°ã¯ã€å…ˆè¡Œã™ã‚‹ã€ŒQuality analysis for auto-fixã€ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ­ã‚°ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
            ä¿®æ­£æ¡ˆã¯ã€ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ãŸãƒ–ãƒ©ãƒ³ãƒ (${{ github.ref_name }}) ã«ç›´æ¥ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚
            ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ŒFix: Apply Claude auto-fix based on quality analysisã€ã¨ã—ã¦ãã ã•ã„ã€‚
            ä¿®æ­£å¾Œã¯ `npm test` ã‚’å®Ÿè¡Œã—ã€ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

  # quality-check ã‚’ run_quality_check ã«ãƒªãƒãƒ¼ãƒ ã—ã€ç›´æ¥ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒå…¥åŠ›ã‚’å‚ç…§
  run_quality_check:
    if: github.event.inputs.action_type == 'run_quality_check'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read # å“è³ªãƒã‚§ãƒƒã‚¯ã®ã¿ãªã®ã§èª­ã¿å–ã‚Šå°‚ç”¨
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Comprehensive quality check
        run: |
          echo "=== å“è³ªãƒã‚§ãƒƒã‚¯çµæœ ==="
          echo "ğŸ” TypeScript (tsc --noEmit --project tsconfig.json):"
          if npx tsc --noEmit --project tsconfig.json; then echo "âœ… æ­£å¸¸"; else echo "âŒ ã‚¨ãƒ©ãƒ¼"; fi
          echo "ğŸ” ESLint (npm run lint):"
          if npm run lint; then echo "âœ… æ­£å¸¸"; else echo "âŒ ã‚¨ãƒ©ãƒ¼"; fi
          echo "ğŸ” ãƒ†ã‚¹ãƒˆ (npm test):"
          if npm test; then echo "âœ… æ­£å¸¸"; else echo "âŒ ã‚¨ãƒ©ãƒ¼"; fi
          echo "ğŸ” ä¾å­˜é–¢ä¿‚ (npm audit --audit-level=high):"
          if npm audit --audit-level=high; then echo "âœ… æ­£å¸¸"; else echo "âš ï¸ è­¦å‘Šã¾ãŸã¯ã‚¨ãƒ©ãƒ¼"; fi
          echo "ğŸ” Target Branch:"
          echo ${{ github.ref_name }} 