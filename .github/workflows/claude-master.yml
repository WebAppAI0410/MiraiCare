name: Claude Master Workflow

on:
  pull_request_review:
    types: [submitted]
  workflow_run:
    workflows: ["RN Unit CI"]
    types: [completed]
    branches: [main]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      action_type:
        description: 'å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        default: 'auto_fix'
        type: choice
        options:
          - auto_fix
          - coderabbit_response
          - quality_check

jobs:
  claude-dispatcher:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: claude-master-${{ github.event.pull_request.number || github.event.issue.number || github.ref }}
      cancel-in-progress: true
    
    outputs:
      action_type: ${{ steps.determine_action.outputs.action_type }}
      should_proceed: ${{ steps.determine_action.outputs.should_proceed }}
    
    steps:
      - name: Determine action type
        id: determine_action
        uses: actions/github-script@v7
        with:
          script: |
            let actionType = 'none';
            let shouldProceed = false;
            
            // Manual dispatch
            if (context.eventName === 'workflow_dispatch') {
              actionType = context.payload.inputs.action_type;
              shouldProceed = true;
            }
            // CodeRabbit review
            else if (context.eventName === 'pull_request_review' && 
                     context.payload.review.user.login === 'coderabbitai[bot]') {
              actionType = 'coderabbit_response';
              shouldProceed = true;
            }
            // CI failure
            else if (context.eventName === 'workflow_run' && 
                     context.payload.workflow_run.conclusion === 'failure') {
              actionType = 'auto_fix';
              shouldProceed = true;
            }
            // Claude mention
            else if (context.eventName === 'issue_comment' && 
                     context.payload.comment.body.includes('@claude')) {
              actionType = 'auto_fix';
              shouldProceed = true;
            }
            
            core.setOutput('action_type', actionType);
            core.setOutput('should_proceed', shouldProceed);
            
            console.log(`Action: ${actionType}, Proceed: ${shouldProceed}`);

  coderabbit-handler:
    needs: claude-dispatcher
    if: needs.claude-dispatcher.outputs.action_type == 'coderabbit_response' && needs.claude-dispatcher.outputs.should_proceed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
      - name: CodeRabbit Response
        uses: actions/github-script@v7
        with:
          script: |
            const reviewBody = context.payload.review.body;
            const prNumber = context.payload.pull_request.number;
            
            const hasSuggestions = reviewBody.includes('**Suggestion:**') || 
                                 reviewBody.includes('**ææ¡ˆ:**');
            
            if (hasSuggestions) {
              const truncatedReview = reviewBody.length > 500 ? 
                reviewBody.substring(0, 500) + '...' : reviewBody;
              
              const responseText = [
                '## ğŸ¤– CodeRabbitãƒ¬ãƒ“ãƒ¥ãƒ¼æ¤œçŸ¥',
                '',
                'CodeRabbitã‹ã‚‰ã®ææ¡ˆã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚',
                '',
                '### ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹',
                truncatedReview,
                '',
                '### ğŸ”§ å¯¾å¿œæ–¹æ³•',
                '1. ææ¡ˆã•ã‚ŒãŸä¿®æ­£ã‚’ç¢ºèª',
                '2. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§ä¿®æ­£',
                '3. ã¾ãŸã¯ @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§è‡ªå‹•ä¿®æ­£ã‚’ä¾é ¼',
                '',
                '---',
                '*CodeRabbitçµ±åˆã‚·ã‚¹ãƒ†ãƒ *'
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: responseText
              });
              
              console.log('CodeRabbitãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¯¾å¿œã—ã¾ã—ãŸ');
            }

  auto-fix-handler:
    needs: claude-dispatcher
    if: needs.claude-dispatcher.outputs.action_type == 'auto_fix' && needs.claude-dispatcher.outputs.should_proceed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 12
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Quality analysis
        id: analysis
        run: |
          echo "=== å“è³ªåˆ†æ ===" | tee analysis.txt
          
          # TypeScript
          echo "typescript_errors=false" >> $GITHUB_OUTPUT
          if ! npx tsc --noEmit 2>&1 | tee -a analysis.txt; then
            echo "typescript_errors=true" >> $GITHUB_OUTPUT
          fi
          
          # ESLint
          echo "eslint_errors=false" >> $GITHUB_OUTPUT
          if ! npm run lint 2>&1 | tee -a analysis.txt; then
            echo "eslint_errors=true" >> $GITHUB_OUTPUT
          fi
          
          # Tests
          echo "test_errors=false" >> $GITHUB_OUTPUT
          if ! npm test 2>&1 | tee -a analysis.txt; then
            echo "test_errors=true" >> $GITHUB_OUTPUT
          fi

      - name: Claude auto-fix
        if: steps.analysis.outputs.typescript_errors == 'true' || steps.analysis.outputs.eslint_errors == 'true' || steps.analysis.outputs.test_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysisContent = fs.readFileSync('analysis.txt', 'utf8');
            
            let targetNumber;
            let contextInfo = '';
            
            // Determine target (PR or Issue)
            if (context.eventName === 'workflow_run') {
              // Find related PR
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });
              
              const pr = prs.data.find(pr => 
                pr.head.ref === context.payload.workflow_run.head_branch
              );
              
              if (pr) {
                targetNumber = pr.number;
                contextInfo = `CIå¤±æ•—: ${context.payload.workflow_run.name}`;
              }
            } else if (context.eventName === 'issue_comment') {
              targetNumber = context.payload.issue.number;
              contextInfo = 'Claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³';
            }
            
            if (targetNumber) {
              const reportLines = [
                '## ğŸ¤– Claudeè‡ªå‹•ä¿®æ­£åˆ†æ',
                '',
                `**ãƒˆãƒªã‚¬ãƒ¼**: ${contextInfo}`,
                `**TypeScript**: ${steps.analysis.outputs.typescript_errors === 'true' ? 'âŒ ã‚¨ãƒ©ãƒ¼' : 'âœ… æ­£å¸¸'}`,
                `**ESLint**: ${steps.analysis.outputs.eslint_errors === 'true' ? 'âŒ ã‚¨ãƒ©ãƒ¼' : 'âœ… æ­£å¸¸'}`,
                `**ãƒ†ã‚¹ãƒˆ**: ${steps.analysis.outputs.test_errors === 'true' ? 'âŒ ã‚¨ãƒ©ãƒ¼' : 'âœ… æ­£å¸¸'}`,
                '',
                '### ğŸ“Š åˆ†æçµæœ',
                '```',
                analysisContent.substring(0, 1000),
                '```',
                '',
                '### ğŸ”§ æ¨å¥¨å¯¾å¿œ',
                '1. æ®µéšçš„ä¿®æ­£: TypeScript â†’ ESLint â†’ ãƒ†ã‚¹ãƒˆ',
                '2. ä¾å­˜é–¢ä¿‚ç¢ºèª: package.jsonæ›´æ–°',
                '3. å‹å®šç¾©è¿½åŠ : ä¸è¶³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ',
                '',
                '---',
                '*Claude Master Workflow*'
              ];

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: targetNumber,
                body: reportLines.join('\n')
              });
              
              console.log(`ä¿®æ­£åˆ†æã‚’PR/Issue #${targetNumber}ã«æŠ•ç¨¿ã—ã¾ã—ãŸ`);
            }

  quality-check:
    needs: claude-dispatcher
    if: needs.claude-dispatcher.outputs.action_type == 'quality_check' && needs.claude-dispatcher.outputs.should_proceed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Comprehensive quality check
        run: |
          echo "=== å“è³ªãƒã‚§ãƒƒã‚¯çµæœ ==="
          
          echo "ğŸ” TypeScript:"
          npx tsc --noEmit && echo "âœ… æ­£å¸¸" || echo "âŒ ã‚¨ãƒ©ãƒ¼"
          
          echo "ğŸ” ESLint:"
          npm run lint && echo "âœ… æ­£å¸¸" || echo "âŒ ã‚¨ãƒ©ãƒ¼"
          
          echo "ğŸ” ãƒ†ã‚¹ãƒˆ:"
          npm test && echo "âœ… æ­£å¸¸" || echo "âŒ ã‚¨ãƒ©ãƒ¼"
          
          echo "ğŸ” ä¾å­˜é–¢ä¿‚:"
          npm audit --audit-level=high && echo "âœ… æ­£å¸¸" || echo "âš ï¸ è­¦å‘Š" 