name: EAS Preview QR Code

on:
  pull_request:
    types: [opened, synchronize]
  workflow_run:
    workflows: ["EAS Update"]
    types: [completed]

jobs:
  generate-qr:
    name: Generate Preview QR Code
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: ğŸ— ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ“± QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã¨ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || 
                           context.payload.workflow_run?.pull_requests[0]?.number;
            
            if (!prNumber) {
              console.log('No PR number found');
              return;
            }
            
            // ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰ãƒãƒ£ãƒ³ãƒãƒ«åã‚’ç”Ÿæˆ
            const branch = context.payload.pull_request?.head.ref || 
                          context.payload.workflow_run?.head_branch;
            const channelName = `pr-${branch.replace(/[^a-zA-Z0-9-]/g, '-').toLowerCase()}`;
            
            // Expo URLã‚’ç”Ÿæˆ
            const expoUrl = `exp://u.expo.dev/update/${channelName}`;
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(expoUrl)}`;
            
            // PRã‚³ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã‚’ç”Ÿæˆ
            const comment = `## ğŸ“± MiraiCare ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

ã“ã®PRã®æœ€æ–°ç‰ˆã‚’ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ç¢ºèªã§ãã¾ã™ï¼

### ğŸ” ç¢ºèªæ–¹æ³•

#### æ–¹æ³•1: QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³
<details>
<summary>QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º</summary>

![QR Code](${qrApiUrl})

</details>

#### æ–¹æ³•2: Expo Goã‚¢ãƒ—ãƒªã§ãƒªãƒ³ã‚¯ã‚’é–‹ã
1. [Expo Go](https://expo.dev/client)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
2. ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¿ãƒƒãƒ—ã¾ãŸã¯ã‚³ãƒ”ãƒ¼ï¼š
   - ğŸ“± **${expoUrl}**

#### æ–¹æ³•3: é–‹ç™ºãƒ“ãƒ«ãƒ‰ã§ç¢ºèª
\`\`\`bash
# iOSã®å ´åˆ
eas update --branch ${channelName} --platform ios

# Androidã®å ´åˆ
eas update --branch ${channelName} --platform android
\`\`\`

### ğŸ“Š ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ±
- **ãƒãƒ£ãƒ³ãƒãƒ«**: \`${channelName}\`
- **æ›´æ–°æ—¥æ™‚**: ${new Date().toISOString()}
- **ã‚³ãƒŸãƒƒãƒˆ**: ${context.sha.substring(0, 7)}

### âš ï¸ æ³¨æ„äº‹é …
- Expo Goã‚¢ãƒ—ãƒªãŒå¿…è¦ã§ã™
- ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã¯åæ˜ ã•ã‚Œã¾ã›ã‚“
- é–‹ç™ºãƒ“ãƒ«ãƒ‰ãŒå¿…è¦ãªæ©Ÿèƒ½ã‚‚ã‚ã‚Šã¾ã™

---
<sub>ğŸ¤– ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ</sub>`;

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('MiraiCare ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼')
            );
            
            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment,
              });
            }
            
            console.log(`âœ… Preview comment posted for PR #${prNumber}`);