name: Claude Post-Validation

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

jobs:
  validate-claude-changes:
    # Claude Codeã«ã‚ˆã‚‹ã‚³ãƒŸãƒƒãƒˆã‹ã‚’åˆ¤å®š
    if: contains(github.event.head_commit.author.name, 'github-actions') || contains(github.event.head_commit.message, '[claude]')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨ã®æ¯”è¼ƒã®ãŸã‚

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm ci || npm install
          fi

      - name: Run TypeScript check
        id: typescript
        run: |
          if [ -f tsconfig.json ]; then
            npx tsc --noEmit || echo "typescript_errors=true" >> $GITHUB_OUTPUT
          fi

      - name: Run ESLint
        id: eslint
        run: |
          if [ -f .eslintrc.js ] || [ -f .eslintrc.json ]; then
            npx eslint . --ext .ts,.tsx --format json --output-file eslint-results.json || echo "eslint_errors=true" >> $GITHUB_OUTPUT
          fi

      - name: Run tests
        id: tests
        run: |
          if [ -f package.json ] && grep -q '"test"' package.json; then
            npm test -- --coverage --watchAll=false || echo "test_errors=true" >> $GITHUB_OUTPUT
          fi

      - name: Build check
        id: build
        run: |
          if [ -f package.json ] && grep -q '"build"' package.json; then
            npm run build || echo "build_errors=true" >> $GITHUB_OUTPUT
          fi

      - name: Analyze changes
        id: analysis
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
            const { execSync } = require('child_process');
            const changedFiles = execSync('git diff --name-only HEAD~1 HEAD', { encoding: 'utf8' }).trim().split('\n');
            
            // ã‚¨ãƒ©ãƒ¼çŠ¶æ³ã‚’ç¢ºèª
            const hasTypeScriptErrors = '${{ steps.typescript.outputs.typescript_errors }}' === 'true';
            const hasESLintErrors = '${{ steps.eslint.outputs.eslint_errors }}' === 'true';
            const hasTestErrors = '${{ steps.tests.outputs.test_errors }}' === 'true';
            const hasBuildErrors = '${{ steps.build.outputs.build_errors }}' === 'true';
            
            const totalErrors = [hasTypeScriptErrors, hasESLintErrors, hasTestErrors, hasBuildErrors].filter(Boolean).length;
            
            // å“è³ªã‚¹ã‚³ã‚¢è¨ˆç®—
            const qualityScore = Math.max(0, 100 - (totalErrors * 25));
            
            // çµæœã‚’ã¾ã¨ã‚ã‚‹
            const validationResult = {
              qualityScore,
              hasErrors: totalErrors > 0,
              changedFiles: changedFiles.filter(f => f.length > 0),
              errors: {
                typescript: hasTypeScriptErrors,
                eslint: hasESLintErrors,
                tests: hasTestErrors,
                build: hasBuildErrors
              }
            };
            
            console.log('Validation Result:', JSON.stringify(validationResult, null, 2));
            
            // çµæœã‚’ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã«è¨­å®š
            core.setOutput('quality_score', qualityScore);
            core.setOutput('has_errors', totalErrors > 0);
            core.setOutput('total_errors', totalErrors);

      - name: Create validation report
        if: steps.analysis.outputs.has_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const qualityScore = '${{ steps.analysis.outputs.quality_score }}';
            const totalErrors = '${{ steps.analysis.outputs.total_errors }}';
            
            const reportBody = `## ğŸ” Claudeä¿®æ­£å¾Œã®å“è³ªãƒã‚§ãƒƒã‚¯çµæœ
            
            **å“è³ªã‚¹ã‚³ã‚¢**: ${qualityScore}/100 ${qualityScore >= 75 ? 'âœ…' : qualityScore >= 50 ? 'âš ï¸' : 'âŒ'}
            
            ### æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ (${totalErrors}ä»¶)
            
            ${${{ steps.typescript.outputs.typescript_errors }} === 'true' ? 'âŒ **TypeScriptã‚¨ãƒ©ãƒ¼**: å‹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—' : 'âœ… TypeScript: æ­£å¸¸'}
            ${${{ steps.eslint.outputs.eslint_errors }} === 'true' ? 'âŒ **ESLintã‚¨ãƒ©ãƒ¼**: ã‚³ãƒ¼ãƒ‰å“è³ªã«å•é¡Œ' : 'âœ… ESLint: æ­£å¸¸'}
            ${${{ steps.tests.outputs.test_errors }} === 'true' ? 'âŒ **ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼**: ãƒ†ã‚¹ãƒˆãŒå¤±æ•—' : 'âœ… ãƒ†ã‚¹ãƒˆ: æ­£å¸¸'}
            ${${{ steps.build.outputs.build_errors }} === 'true' ? 'âŒ **ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼**: ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—' : 'âœ… ãƒ“ãƒ«ãƒ‰: æ­£å¸¸'}
            
            ### ğŸ¯ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            
            ${qualityScore < 50 ? `
            **ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™**:
            1. Claudeä¿®æ­£å†…å®¹ã®è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼
            2. æ‰‹å‹•ã§ã®è¿½åŠ ä¿®æ­£
            3. å†åº¦ã®å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
            ` : qualityScore < 75 ? `
            **è¿½åŠ ä¿®æ­£ã‚’æ¨å¥¨ã—ã¾ã™**:
            1. æ®‹å­˜ã‚¨ãƒ©ãƒ¼ã®ç¢ºèª
            2. å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ä¿®æ­£
            ` : `
            **å“è³ªè‰¯å¥½ã§ã™**:
            - è»½å¾®ãªå•é¡Œã®ã¿ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£
            `}
            
            ### ğŸ¤– è‡ªå‹•å¯¾å¿œ
            
            ${totalErrors > 0 ? `
            æ–°ã—ã„Issueã‚’è‡ªå‹•ä½œæˆã—ã€æ®‹å­˜å•é¡Œã®ä¿®æ­£ã‚’ä¾é ¼ã—ã¾ã™ã€‚
            ` : `
            ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚
            `}
            
            ---
            *Claudeä¿®æ­£å¾Œå“è³ªãƒã‚§ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ *`;
            
            // æ–°ã—ã„Issueã‚’ä½œæˆï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆï¼‰
            if (totalErrors > 0) {
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Claudeä¿®æ­£å¾Œ] å“è³ªãƒã‚§ãƒƒã‚¯ã§å•é¡Œæ¤œå‡º (ã‚¹ã‚³ã‚¢: ${qualityScore}/100)`,
                body: reportBody + `
                
                ### ğŸ“Š è©³ç´°æƒ…å ±
                
                - **å…ƒã®ã‚³ãƒŸãƒƒãƒˆ**: ${context.sha}
                - **ä¿®æ­£è€…**: Claude Code
                - **æ¤œè¨¼æ™‚åˆ»**: ${new Date().toISOString()}
                
                @claude ã“ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚`,
                labels: ['claude-validation', 'needs-fix', 'auto-detected']
              });
              
              console.log(`æ–°ã—ã„Issue #${newIssue.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ`);
            }

      - name: Update commit status
        uses: actions/github-script@v7
        with:
          script: |
            const qualityScore = parseInt('${{ steps.analysis.outputs.quality_score }}');
            const hasErrors = '${{ steps.analysis.outputs.has_errors }}' === 'true';
            
            const state = qualityScore >= 75 ? 'success' : qualityScore >= 50 ? 'pending' : 'failure';
            const description = `å“è³ªã‚¹ã‚³ã‚¢: ${qualityScore}/100 ${hasErrors ? '(å•é¡Œã‚ã‚Š)' : '(æ­£å¸¸)'}`;
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: state,
              target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'Claude Post-Validation'
            }); 