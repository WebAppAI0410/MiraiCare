name: Claude Auto Fix V2

on:
  workflow_run:
    workflows: ["RN Unit CI"]
    types: [completed]

jobs:
  auto-fix-ci-failures:
    # CIå¤±æ•—æ™‚ã®ã¿å®Ÿè¡Œã€é‡è¤‡é˜²æ­¢
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: claude-auto-fix-${{ github.event.workflow_run.head_branch }}
      cancel-in-progress: true
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR and retry count
        id: pr_details
        uses: actions/github-script@v7
        with:
          script: |
            // é–¢é€£ã™ã‚‹PRã‚’æ¤œç´¢
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const pr = prs.data.find(pr => 
              pr.head.ref.startsWith('claude/issue-') || 
              pr.title.includes('Claudeå®Ÿè£…')
            );
            
            if (!pr) {
              console.log('é–¢é€£ã™ã‚‹PRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              return;
            }
            
            // éå»24æ™‚é–“ã®Claudeä¿®æ­£è©¦è¡Œå›æ•°ã‚’ãƒã‚§ãƒƒã‚¯
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });
            
            const claudeFixComments = comments.data.filter(comment => 
              comment.body.includes('@claude CIå¤±æ•—ã‚’ä¿®æ­£') &&
              new Date(comment.created_at) > new Date(Date.now() - 24 * 60 * 60 * 1000)
            );
            
            const retryCount = claudeFixComments.length;
            const maxRetries = 3;
            
            core.setOutput('pr_number', pr.number);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('retry_count', retryCount);
            core.setOutput('max_retries', maxRetries);
            core.setOutput('should_retry', retryCount < maxRetries);
            
            console.log(`PR #${pr.number}, ä¿®æ­£è©¦è¡Œå›æ•°: ${retryCount}/${maxRetries}`);
            
            return { prNumber: pr.number, retryCount, shouldRetry: retryCount < maxRetries };

      - name: Check CI failures
        if: steps.pr_details.outputs.should_retry == 'true'
        id: ci_status
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.pr_details.outputs.pr_number }}';
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const failedChecks = checks.check_runs.filter(check => 
              check.conclusion === 'failure' && 
              (check.name.includes('test') || check.name.includes('lint') || check.name.includes('tsc'))
            );
            
            core.setOutput('has_failures', failedChecks.length > 0);
            core.setOutput('failed_checks', JSON.stringify(failedChecks.map(c => c.name)));
            
            return failedChecks;

      - name: Send Claude fix request
        if: steps.pr_details.outputs.should_retry == 'true' && steps.ci_status.outputs.has_failures == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.pr_details.outputs.pr_number }}';
            const failedChecks = '${{ steps.ci_status.outputs.failed_checks }}';
            const retryCount = '${{ steps.pr_details.outputs.retry_count }}';
            
            const commentBody = [
              '@claude CIå¤±æ•—ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„',
              '',
              '## ğŸš¨ CIå¤±æ•—ã®è©³ç´°',
              `å¤±æ•—ã—ãŸãƒã‚§ãƒƒã‚¯: ${failedChecks}`,
              `ä¿®æ­£è©¦è¡Œå›æ•°: ${parseInt(retryCount) + 1}/3`,
              '',
              '## ğŸ“‹ ä¿®æ­£ãŒå¿…è¦ãªé …ç›®',
              '- [ ] TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£',
              '- [ ] ä¸è¶³ã—ã¦ã„ã‚‹ä¾å­˜é–¢ä¿‚ã®è¿½åŠ ', 
              '- [ ] ESLintã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£',
              '- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ä¿®æ­£',
              '',
              '## ğŸ¯ TDDã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã®ä¿®æ­£æ‰‹é †',
              '1. **Red**: å¤±æ•—ã—ã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆã‚’ç‰¹å®š',
              '2. **Green**: æœ€å°é™ã®ä¿®æ­£ã§ãƒ†ã‚¹ãƒˆã‚’é€šã™',
              '3. **Refactor**: ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’å‘ä¸Š',
              '',
              '## ğŸ“¦ ä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ä¾å­˜é–¢ä¿‚',
              '- `@testing-library/react-native`',
              '- `@types/jest`',
              '- `jest-expo`',
              '- `zustand`',
              '- `@supabase/supabase-js`',
              '- `@react-native-async-storage/async-storage`',
              '',
              'package.jsonã«è¿½åŠ ã—ã€TypeScriptã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚'
            ].join('\\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
            
            console.log(`Claudeä¿®æ­£è¦æ±‚ã‚’é€ä¿¡ã—ã¾ã—ãŸ (è©¦è¡Œ ${parseInt(retryCount) + 1}/3)`);

      - name: Max retries reached
        if: steps.pr_details.outputs.should_retry == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.pr_details.outputs.pr_number }}';
            
            const commentBody = [
              '## âš ï¸ è‡ªå‹•ä¿®æ­£ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸ',
              '',
              'Claude Code Actionsã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£ãŒ3å›å¤±æ•—ã—ã¾ã—ãŸã€‚',
              'æ‰‹å‹•ã§ã®ç¢ºèªã¨ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚',
              '',
              '## ğŸ” æ¨å¥¨ã•ã‚Œã‚‹æ‰‹å‹•å¯¾å¿œ',
              '1. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ',
              '2. `npm install` ã§ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèª',
              '3. `npx tsc --noEmit` ã§TypeScriptã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª',
              '4. `npm run lint` ã§ESLintã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª',
              '5. `npm test` ã§ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª',
              '',
              '## ğŸ·ï¸ ãƒ©ãƒ™ãƒ«è¿½åŠ ',
              'ã“ã®PRã« `manual-review-required` ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚'
            ].join('\\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
            
            // ãƒ©ãƒ™ãƒ«è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['manual-review-required', 'auto-fix-failed']
            });
            
            console.log('æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ãªPRã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã—ãŸ'); 