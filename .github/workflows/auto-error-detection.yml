name: Auto Error Detection & Issue Creation

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch: {}
  # workflow_runã¯å‰Šé™¤ - claude-auto-fix-v2.ymlãŒæ‹…å½“

jobs:
  detect-errors:
    if: ${{ github.event.workflow_run.conclusion == 'failure' || always() }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: error-detection-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
      issues: write
      pull-requests: write
      actions: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies (if possible)
        run: npm ci || npm install || echo "Dependencies installation failed"
        continue-on-error: true

      - name: Run linter and collect errors
        id: lint-check
        run: |
          npm run lint 2>&1 | tee lint-output.txt || echo "Lint failed"
          if [ $? -ne 0 ]; then
            echo "lint_failed=true" >> $GITHUB_OUTPUT
          else
            echo "lint_failed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run tests and collect errors
        id: test-check
        run: |
          npm test 2>&1 | tee test-output.txt || echo "Tests failed"
          if [ $? -ne 0 ]; then
            echo "test_failed=true" >> $GITHUB_OUTPUT
          else
            echo "test_failed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check TypeScript compilation
        id: tsc-check
        run: |
          npx tsc --noEmit 2>&1 | tee tsc-output.txt || echo "TypeScript compilation failed"
          if [ $? -ne 0 ]; then
            echo "tsc_failed=true" >> $GITHUB_OUTPUT
          else
            echo "tsc_failed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Analyze errors and create issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read error outputs
            let lintErrors = '';
            let testErrors = '';
            let tscErrors = '';
            
            try {
              lintErrors = fs.readFileSync('lint-output.txt', 'utf8');
            } catch (e) {}
            
            try {
              testErrors = fs.readFileSync('test-output.txt', 'utf8');
            } catch (e) {}
            
            try {
              tscErrors = fs.readFileSync('tsc-output.txt', 'utf8');
            } catch (e) {}

            // Determine Claude model based on error complexity
            let claudeModel = '[haiku]';
            const errorCount = (lintErrors.match(/error/gi) || []).length + 
                              (testErrors.match(/error/gi) || []).length + 
                              (tscErrors.match(/error/gi) || []).length;
            
            console.log(`Total errors detected: ${errorCount}`);
            
            if (errorCount > 10) {
              claudeModel = '[opus]';
            } else if (errorCount > 3) {
              claudeModel = '[sonnet]';
            }
            
            // Only create issue if there are actual errors
            if (errorCount === 0) {
              console.log('No errors detected, skipping issue creation');
              return;
            }

            // Create comprehensive issue body
            const issueBody = `@claude ${claudeModel}

            ## ğŸ¤– è‡ªå‹•æ¤œçŸ¥ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼

            ã“ã®Issueã¯è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ä½œæˆã•ã‚Œã¾ã—ãŸã€‚

            ### ğŸ“Š ã‚¨ãƒ©ãƒ¼æ¦‚è¦
            - Lint ã‚¨ãƒ©ãƒ¼: ${(lintErrors.match(/error/gi) || []).length}å€‹
            - Test ã‚¨ãƒ©ãƒ¼: ${(testErrors.match(/error/gi) || []).length}å€‹  
            - TypeScript ã‚¨ãƒ©ãƒ¼: ${(tscErrors.match(/error/gi) || []).length}å€‹

            ### ğŸ” è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±

            ${lintErrors ? `#### ESLint ã‚¨ãƒ©ãƒ¼
            \`\`\`
            ${lintErrors.slice(0, 2000)}
            \`\`\`
            ` : ''}

            ${testErrors ? `#### ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼
            \`\`\`
            ${testErrors.slice(0, 2000)}
            \`\`\`
            ` : ''}

            ${tscErrors ? `#### TypeScript ã‚¨ãƒ©ãƒ¼
            \`\`\`
            ${tscErrors.slice(0, 2000)}
            \`\`\`
            ` : ''}

            ### âœ… ä¿®æ­£è¦æ±‚
            - [ ] ã™ã¹ã¦ã®lintã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
            - [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
            - [ ] TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
            - [ ] ä¸è¶³ã—ã¦ã„ã‚‹ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ 
            - [ ] è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©åˆ‡ã«æ§‹æˆ

            ### ğŸ”– åˆ¶ç´„
            - TypeScript strict modeã‚’ç¶­æŒ
            - React Native best practicesã«å¾“ã†
            - æ—¢å­˜ã®æ©Ÿèƒ½ã‚’ç ´å£Šã—ãªã„
            - é©åˆ‡ãªãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
            - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¦ä»¶ã‚’æº€ãŸã™

            ### ğŸ“ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            - ãƒ–ãƒ©ãƒ³ãƒ: ${context.ref}
            - ã‚³ãƒŸãƒƒãƒˆ: ${context.sha}
            - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${context.workflow}
            - å®Ÿè¡Œè€…: ${context.actor}
            `;

            // Check if similar issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-detected,bug'
            });

            const similarIssue = existingIssues.data.find(issue => 
              issue.title.includes('è‡ªå‹•æ¤œçŸ¥ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼') && 
              issue.body.includes(context.sha.slice(0, 7))
            );

            if (!similarIssue) {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[auto] è‡ªå‹•æ¤œçŸ¥ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody,
                labels: ['auto-detected', 'bug', 'needs-fix']
              });

              console.log(`Created issue #${issue.data.number}`);
            } else {
              console.log(`Similar issue already exists: #${similarIssue.number}`);
            } 