name: Auto Error Detection (Main Branch Only)

on:
  push:
    branches: [main]
  workflow_dispatch: {}
  # PRã¯å‰Šé™¤ - claude-auto-fix-v2.ymlãŒåŠ¹ç‡çš„ã«å‡¦ç†

jobs:
  detect-main-errors:
    # mainãƒ–ãƒ©ãƒ³ãƒã§ã®ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ã®ã¿ï¼ˆPRã¯é™¤å¤–ï¼‰
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: error-detection-main
      cancel-in-progress: true
    permissions:
      contents: read
      issues: write
      actions: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install
        continue-on-error: true

      - name: Run comprehensive error check
        id: error-check
        run: |
          echo "=== TypeScript Check ===" | tee error-summary.txt
          npx tsc --noEmit 2>&1 | tee -a error-summary.txt || echo "TypeScript failed"
          
          echo -e "\n=== ESLint Check ===" | tee -a error-summary.txt
          npm run lint 2>&1 | tee -a error-summary.txt || echo "ESLint failed"
          
          echo -e "\n=== Test Check ===" | tee -a error-summary.txt
          npm test 2>&1 | tee -a error-summary.txt || echo "Tests failed"
          
          # ã‚¨ãƒ©ãƒ¼æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          ERROR_COUNT=$(grep -i "error" error-summary.txt | wc -l || echo "0")
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Create main branch issue (if needed)
        if: steps.error-check.outputs.has_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errorSummary = fs.readFileSync('error-summary.txt', 'utf8');
            const errorCount = '${{ steps.error-check.outputs.error_count }}';
            
            // æ—¢å­˜ã®mainãƒ–ãƒ©ãƒ³ãƒã‚¨ãƒ©ãƒ¼Issueã‚’ãƒã‚§ãƒƒã‚¯
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'main-branch-error'
            });
            
            if (existingIssues.data.length > 0) {
              // æ—¢å­˜Issueã‚’æ›´æ–°
              const issue = existingIssues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ğŸ”„ mainãƒ–ãƒ©ãƒ³ãƒã‚¨ãƒ©ãƒ¼æ›´æ–°\\n\\n**ã‚³ãƒŸãƒƒãƒˆ**: ${context.sha}\\n**ã‚¨ãƒ©ãƒ¼æ•°**: ${errorCount}\\n\\n\`\`\`\\n${errorSummary.slice(0, 1500)}\\n\`\`\``
              });
              console.log(`æ—¢å­˜Issue #${issue.number} ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
            } else {
              // æ–°ã—ã„Issueã‚’ä½œæˆï¼ˆmainãƒ–ãƒ©ãƒ³ãƒç”¨ã®ã¿ï¼‰
              let claudeModel = '[haiku]';
              if (parseInt(errorCount) > 10) {
                claudeModel = '[opus]';
              } else if (parseInt(errorCount) > 3) {
                claudeModel = '[sonnet]';
              }
              
              const issueBody = `@claude ${claudeModel}\\n\\n## ğŸš¨ mainãƒ–ãƒ©ãƒ³ãƒã§ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\\n\\n**é‡è¦**: ã“ã‚Œã¯mainãƒ–ãƒ©ãƒ³ãƒã®å“è³ªå•é¡Œã§ã™ã€‚å„ªå…ˆçš„ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\\n\\n### ğŸ“Š ã‚¨ãƒ©ãƒ¼æ¦‚è¦\\n- **ã‚¨ãƒ©ãƒ¼æ•°**: ${errorCount}å€‹\\n- **ã‚³ãƒŸãƒƒãƒˆ**: ${context.sha}\\n- **ç™ºç”Ÿæ—¥æ™‚**: ${new Date().toISOString()}\\n\\n### ğŸ” è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±\\n\`\`\`\\n${errorSummary.slice(0, 2000)}\\n\`\`\`\\n\\n### âœ… ä¿®æ­£è¦æ±‚\\n- [ ] TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£\\n- [ ] ESLintã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£\\n- [ ] ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£\\n- [ ] ä¸è¶³ã—ã¦ã„ã‚‹ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ \\n\\n### ğŸ¯ ä¿®æ­£æ–¹é‡\\n1. **ç·Šæ€¥åº¦**: é«˜ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®å“è³ªå•é¡Œï¼‰\\n2. **å¯¾è±¡**: mainãƒ–ãƒ©ãƒ³ãƒã§ç›´æ¥ä¿®æ­£\\n3. **ãƒ†ã‚¹ãƒˆ**: ä¿®æ­£å¾Œã«å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ\\n4. **ç¢ºèª**: CIé€šéã‚’ç¢ºèª\\n\\n---\\n*mainãƒ–ãƒ©ãƒ³ãƒå“è³ªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆ*`;

              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ [URGENT] mainãƒ–ãƒ©ãƒ³ãƒã‚¨ãƒ©ãƒ¼æ¤œå‡º - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody,
                labels: ['main-branch-error', 'urgent', 'bug']
              });
              
              console.log(`mainãƒ–ãƒ©ãƒ³ãƒã‚¨ãƒ©ãƒ¼Issue #${issue.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ`);
            }

      - name: Success notification
        if: steps.error-check.outputs.has_errors == 'false'
        run: |
          echo "âœ… mainãƒ–ãƒ©ãƒ³ãƒã¯æ­£å¸¸ã§ã™ - ã‚¨ãƒ©ãƒ¼ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" 