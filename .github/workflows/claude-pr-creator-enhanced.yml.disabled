name: Claude PR Creator Enhanced

on:
  push:
    branches:
      - 'claude/issue-*'
  workflow_run:
    workflows: ["Claude Code Actions"]
    types: [completed]

jobs:
  create-pr:
    if: |
      (github.event_name == 'push' && startsWith(github.ref_name, 'claude/issue-')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue number from branch
        id: extract_issue
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            BRANCH_NAME="${{ github.ref_name }}"
          else
            # workflow_runã®å ´åˆã€æœ€æ–°ã®claude/issue-*ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
            BRANCH_NAME=$(git branch -r | grep 'origin/claude/issue-' | sort -V | tail -1 | sed 's/.*origin\///')
          fi
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          if [[ $BRANCH_NAME =~ claude/issue-([0-9]+) ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "Found issue number: $ISSUE_NUMBER"
          else
            echo "Could not extract issue number from branch: $BRANCH_NAME"
            exit 1
          fi

      - name: Check if PR already exists
        id: check_pr
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.extract_issue.outputs.branch_name }}';
            
            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });
            
            if (existingPRs.data.length > 0) {
              console.log(`PR already exists: #${existingPRs.data[0].number}`);
              core.setOutput('pr_exists', 'true');
              core.setOutput('pr_number', existingPRs.data[0].number);
            } else {
              console.log('No existing PR found');
              core.setOutput('pr_exists', 'false');
            }

      - name: Get issue details
        if: steps.check_pr.outputs.pr_exists == 'false'
        id: get_issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.extract_issue.outputs.issue_number }}';
            
            try {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              core.setOutput('issue_title', issue.data.title);
              core.setOutput('issue_body', issue.data.body || '');
              core.setOutput('issue_labels', JSON.stringify(issue.data.labels.map(label => label.name)));
              
              return issue.data;
            } catch (error) {
              console.error(`Failed to get issue #${issueNumber}:`, error);
              core.setOutput('issue_title', `Issue #${issueNumber}`);
              core.setOutput('issue_body', '');
              core.setOutput('issue_labels', '[]');
            }

      - name: Get commit details
        if: steps.check_pr.outputs.pr_exists == 'false'
        id: get_commits
        run: |
          BRANCH_NAME="${{ steps.extract_issue.outputs.branch_name }}"
          
          # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
          LATEST_COMMIT_MSG=$(git log origin/$BRANCH_NAME --oneline -1 --pretty=format:"%s" || echo "Claude Code Actions ã«ã‚ˆã‚‹ä¿®æ­£")
          echo "latest_commit_msg=$LATEST_COMMIT_MSG" >> $GITHUB_OUTPUT
          
          # ã‚³ãƒŸãƒƒãƒˆæ•°ã‚’å–å¾—
          COMMIT_COUNT=$(git rev-list --count origin/main..origin/$BRANCH_NAME || echo "1")
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only origin/main..origin/$BRANCH_NAME | wc -l || echo "0")
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_pr.outputs.pr_exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.extract_issue.outputs.issue_number }}';
            const branchName = '${{ steps.extract_issue.outputs.branch_name }}';
            const issueTitle = '${{ steps.get_issue.outputs.issue_title }}';
            const issueBody = '${{ steps.get_issue.outputs.issue_body }}';
            const latestCommitMsg = '${{ steps.get_commits.outputs.latest_commit_msg }}';
            const commitCount = '${{ steps.get_commits.outputs.commit_count }}';
            const changedFiles = '${{ steps.get_commits.outputs.changed_files }}';
            
            // PRã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
            const prTitle = `ğŸ¤– Claudeå®Ÿè£…: ${issueTitle}`;
            
            // PRæœ¬æ–‡ã‚’ç”Ÿæˆ
            const prBody = `## ğŸ¤– Claude Code Actions ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…\n\n### ğŸ“‹ é–¢é€£Issue\nCloses #${issueNumber}\n\n### ğŸ¯ å®Ÿè£…å†…å®¹\nClaude Code Actionsã«ã‚ˆã‚Š Issue #${issueNumber} ã®è¦ä»¶ã«åŸºã¥ãæ©Ÿèƒ½å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n**æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ**: ${latestCommitMsg}\n\n### ğŸ“Š å¤‰æ›´æ¦‚è¦\n- **ã‚³ãƒŸãƒƒãƒˆæ•°**: ${commitCount}\n- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${changedFiles}\n- **ãƒ–ãƒ©ãƒ³ãƒ**: \`${branchName}\`\n\n### âœ… å“è³ªãƒã‚§ãƒƒã‚¯\n- [ ] TypeScriptå‹ãƒã‚§ãƒƒã‚¯é€šé\n- [ ] ESLintã‚¨ãƒ©ãƒ¼ãªã—\n- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆé€šé\n- [ ] æ‰‹å‹•å‹•ä½œç¢ºèª\n\n### ğŸš€ ãƒ†ã‚¹ãƒˆæ‰‹é †\n\`\`\`bash\ngit checkout ${branchName}\nnpm install\nnpm run lint && npx tsc --noEmit && npm test\nnpm start\n\`\`\`\n\n### ğŸ“ å…ƒã®Issueå†…å®¹\n${issueBody}\n\n---\n*ã“ã®PRã¯Claude Code Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*\n*Generated with [Claude Code](https://claude.ai/code)*`;

            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                head: branchName,
                base: 'main',
                body: prBody,
                draft: false
              });
              
              console.log(`âœ… PRä½œæˆå®Œäº†: #${pr.data.number}`);
              console.log(`ğŸ”— PR URL: ${pr.data.html_url}`);
              
              // Issueé€šçŸ¥
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `## ğŸ‰ PRè‡ªå‹•ä½œæˆå®Œäº†ï¼\n\nClaude Code Actionsã«ã‚ˆã‚‹å®Ÿè£…ãŒå®Œäº†ã—ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•ä½œæˆã—ã¾ã—ãŸã€‚\n\n**PR**: #${pr.data.number}\n**ãƒ–ãƒ©ãƒ³ãƒ**: \`${branchName}\`\n**URL**: ${pr.data.html_url}\n\n### ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—\n1. å“è³ªãƒã‚§ãƒƒã‚¯çµæœç¢ºèª\n2. æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n3. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n4. ãƒãƒ¼ã‚¸å®Ÿè¡Œ\n\nãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å¾Œã€ãƒãƒ¼ã‚¸ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼`
              });
              
              return pr.data;
            } catch (error) {
              console.error('PRä½œæˆã«å¤±æ•—:', error);
              
              // Issueé€šçŸ¥ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `## âŒ PRè‡ªå‹•ä½œæˆã«å¤±æ•—\n\nClaude Code Actionsã«ã‚ˆã‚‹å®Ÿè£…ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€PRä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n**ãƒ–ãƒ©ãƒ³ãƒ**: \`${branchName}\`\n**æ‰‹å‹•PRä½œæˆ**: [ã“ã¡ã‚‰ã‚’ã‚¯ãƒªãƒƒã‚¯](https://github.com/${context.repo.owner}/${context.repo.repo}/compare/main...${branchName})\n\n**ã‚¨ãƒ©ãƒ¼**: ${error.message}\n\næ‰‹å‹•ã§PRã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`
              });
              
              throw error;
            } 