name: Claude PR Creator Simple

on:
  workflow_run:
    workflows: ["Claude Code Actions"]
    types: [completed]
    branches: [main]
  schedule: # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã‚’è¿½åŠ 
    - cron: '0 */1 * * *' # 1æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      max_branches_to_process:
        description: '1å›ã®å®Ÿè¡Œã§å‡¦ç†ã™ã‚‹æœ€å¤§ãƒ–ãƒ©ãƒ³ãƒæ•°'
        required: false
        default: '5'

jobs:
  create-pr:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find Claude branches without PRs
        id: find_branches
        uses: actions/github-script@v7
        with:
          script: |
            console.log('--- Starting PR Creation Script ---');
            console.log(`Triggered by: ${context.eventName}`);

            let maxBranches;
            if (context.eventName === 'workflow_dispatch') {
              maxBranches = parseInt(context.payload.inputs.max_branches_to_process || '5');
            } else {
              // workflow_run ã‚„ schedule ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
              maxBranches = 5; 
            }
            console.log(`Max branches to process in this run: ${maxBranches}`);
            
            let branchesProcessed = 0;
            let branchesRemaining = false;

            let allBranches;
            try {
              allBranches = await github.rest.repos.listBranches({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              console.log(`Successfully fetched ${allBranches.data.length} branches in total.`);
            } catch (error) {
              core.setFailed(`Failed to list branches: ${error.message}`);
              return;
            }
            
            const claudeBranches = allBranches.data.filter(branch => 
              branch.name.startsWith('claude/issue-')
            );
            console.log(`Found ${claudeBranches.length} branches starting with \'claude/issue-\'.`);
            
            if (claudeBranches.length === 0) {
              console.log('No claude/issue-* branches found. Exiting.');
              core.setOutput('branches_remaining', false);
              return;
            }
            
            for (const branch of claudeBranches) {
              if (branchesProcessed >= maxBranches) {
                console.log('Max branches limit reached for this run. Remaining branches will be handled in the next run.');
                branchesRemaining = true;
                break;
              }

              console.log(`--- Processing branch: ${branch.name} ---`);
              
              let existingPRs;
              try {
                existingPRs = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head: `${context.repo.owner}:${branch.name}`,
                  state: 'all'
                });
                console.log(`Found ${existingPRs.data.length} existing PR(s) for branch ${branch.name}.`);
              } catch (error) {
                console.error(`Failed to list PRs for branch ${branch.name}: ${error.message}`);
                continue; // æ¬¡ã®ãƒ–ãƒ©ãƒ³ãƒã¸
              }
              
              if (existingPRs.data.length === 0) {
                console.log(`No existing PR found for ${branch.name}. Attempting to create one.`);
                const match = branch.name.match(/claude\/issue-(\d+)/);
                if (match) {
                  const issueNumber = match[1];
                  console.log(`Extracted issue number: ${issueNumber} for branch ${branch.name}.`);
                  try {
                    const issue = await github.rest.issues.get({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber
                    });
                    console.log(`Successfully fetched details for Issue #${issueNumber}: ${issue.data.title}`);
                    
                    const pr = await github.rest.pulls.create({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      title: `ğŸ¤– Claudeå®Ÿè£…: ${issue.data.title}`,
                      head: branch.name,
                      base: 'main',
                      body: `## ğŸ¤– Claude Code Actions ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…\n\n### ğŸ“‹ é–¢é€£Issue\nCloses #${issueNumber}\n\n### ğŸ¯ å®Ÿè£…å†…å®¹\nClaude Code Actionsã«ã‚ˆã‚Š Issue #${issueNumber} ã®è¦ä»¶ã«åŸºã¥ãæ©Ÿèƒ½å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n**ãƒ–ãƒ©ãƒ³ãƒ**: \`${branch.name}\`\n\n### âœ… å“è³ªãƒã‚§ãƒƒã‚¯\n- [ ] TypeScriptå‹ãƒã‚§ãƒƒã‚¯é€šé\n- [ ] ESLintã‚¨ãƒ©ãƒ¼ãªã—\n- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆé€šé\n- [ ] æ‰‹å‹•å‹•ä½œç¢ºèª\n\n---\n*ã“ã®PRã¯Claude Code Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`
                    });
                    console.log(`âœ… PR #${pr.data.number} created for Issue #${issueNumber} from branch ${branch.name}. URL: ${pr.data.html_url}`);
                    branchesProcessed++;
                    
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      body: `## ğŸ‰ PRè‡ªå‹•ä½œæˆå®Œäº†ï¼\n\nClaude Code Actionsã«ã‚ˆã‚‹å®Ÿè£…ãŒå®Œäº†ã—ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•ä½œæˆã—ã¾ã—ãŸã€‚\n\n**PR**: #${pr.data.number}\n**ãƒ–ãƒ©ãƒ³ãƒ**: \`${branch.name}\`\n**URL**: ${pr.data.html_url}\n\nãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å¾Œã€ãƒãƒ¼ã‚¸ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼`
                    });
                    console.log(`Posted comment on Issue #${issueNumber} about new PR.`);

                  } catch (error) {
                    core.setFailed(`Error during PR creation or commenting for Issue #${issueNumber} (branch ${branch.name}): ${error.message}`);
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚æ¬¡ã®ãƒ–ãƒ©ãƒ³ãƒã®å‡¦ç†ã‚’è©¦ã¿ã‚‹å ´åˆã¯ core.setFailed ã‚’ä½¿ã‚ãš console.error ã®ã¿
                    console.error(`Error processing Issue #${issueNumber} (branch ${branch.name}): ${error.message}`);
                  }
                } else {
                  console.warn(`Could not extract issue number from branch name: ${branch.name}`);
                }
              } else {
                console.log(`PR already exists for branch ${branch.name}. Skipping.`);
              }
            }
            core.setOutput('branches_remaining', branchesRemaining);
            console.log('--- Finished PR Creation Script ---');

      # è‡ªå·±å†ãƒˆãƒªã‚¬ãƒ¼ã®ä»£ã‚ã‚Šã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã«ä¾å­˜ã™ã‚‹ãŸã‚ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
      # - name: Trigger self if more branches exist 
      #   if: steps.find_branches.outputs.branches_remaining == 'true'
      #   run: echo "More branches to process. Next scheduled run or manual dispatch will handle them." 