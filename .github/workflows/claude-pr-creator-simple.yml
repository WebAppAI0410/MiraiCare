name: Claude PR Creator Simple

on:
  workflow_run:
    workflows: ["Claude Code Actions"]
    types: [completed]
    branches: [main]

jobs:
  create-pr:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find Claude branches without PRs
        id: find_branches
        uses: actions/github-script@v7
        with:
          script: |
            // å…¨ã¦ã®claude/issue-*ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
            const branches = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const claudeBranches = branches.data.filter(branch => 
              branch.name.startsWith('claude/issue-')
            );
            
            console.log(`Found ${claudeBranches.length} Claude branches`);
            
            for (const branch of claudeBranches) {
              console.log(`Checking branch: ${branch.name}`);
              
              // æ—¢å­˜PRã‚’ãƒã‚§ãƒƒã‚¯
              const existingPRs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch.name}`,
                state: 'all'
              });
              
              if (existingPRs.data.length === 0) {
                console.log(`No PR found for branch: ${branch.name}`);
                
                // Issueç•ªå·ã‚’æŠ½å‡º
                const match = branch.name.match(/claude\/issue-(\d+)/);
                if (match) {
                  const issueNumber = match[1];
                  
                  try {
                    // Issueã®è©³ç´°ã‚’å–å¾—
                    const issue = await github.rest.issues.get({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber
                    });
                    
                    // PRã‚’ä½œæˆ
                    const pr = await github.rest.pulls.create({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      title: `ğŸ¤– Claudeå®Ÿè£…: ${issue.data.title}`,
                      head: branch.name,
                      base: 'main',
                      body: `## ğŸ¤– Claude Code Actions ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…\n\n### ğŸ“‹ é–¢é€£Issue\nCloses #${issueNumber}\n\n### ğŸ¯ å®Ÿè£…å†…å®¹\nClaude Code Actionsã«ã‚ˆã‚Š Issue #${issueNumber} ã®è¦ä»¶ã«åŸºã¥ãæ©Ÿèƒ½å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n**ãƒ–ãƒ©ãƒ³ãƒ**: \`${branch.name}\`\n\n### âœ… å“è³ªãƒã‚§ãƒƒã‚¯\n- [ ] TypeScriptå‹ãƒã‚§ãƒƒã‚¯é€šé\n- [ ] ESLintã‚¨ãƒ©ãƒ¼ãªã—\n- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆé€šé\n- [ ] æ‰‹å‹•å‹•ä½œç¢ºèª\n\n---\n*ã“ã®PRã¯Claude Code Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`
                    });
                    
                    console.log(`âœ… PRä½œæˆå®Œäº†: #${pr.data.number} for Issue #${issueNumber}`);
                    
                    // Issueé€šçŸ¥
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      body: `## ğŸ‰ PRè‡ªå‹•ä½œæˆå®Œäº†ï¼\n\nClaude Code Actionsã«ã‚ˆã‚‹å®Ÿè£…ãŒå®Œäº†ã—ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•ä½œæˆã—ã¾ã—ãŸã€‚\n\n**PR**: #${pr.data.number}\n**ãƒ–ãƒ©ãƒ³ãƒ**: \`${branch.name}\`\n**URL**: ${pr.data.html_url}\n\nãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å¾Œã€ãƒãƒ¼ã‚¸ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼`
                    });
                    
                  } catch (error) {
                    console.error(`Failed to create PR for Issue #${issueNumber}:`, error);
                  }
                }
              } else {
                console.log(`PR already exists for branch: ${branch.name}`);
              }
            } 