name: Claude Unified

on:
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:
    inputs:
      action_type:
        description: 'å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        default: 'quality_check'
        type: choice
        options:
          - autofix
          - quality_check

jobs:
  # æ‰‹å‹•ã‚³ãƒ¡ãƒ³ãƒˆå¯¾å¿œï¼ˆ@claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼‰
  manual_request:
    if: |
      github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') ||
      github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: claude-manual-${{ github.event.issue.number || github.event.pull_request.number }}-${{ github.event.comment.id }}
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}

      - name: Claude Response
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"
          timeout_minutes: "15"
          # æœ€å°é™ã®ãƒ„ãƒ¼ãƒ«ã‚»ãƒƒãƒˆã«åˆ¶é™
          allowed_tools: "View,Edit,GrepTool,Bash(npm test),Bash(npm run lint)"
          custom_instructions: |
            MiraiCareï¼ˆReact Native + TypeScript + Supabaseï¼‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
            ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã®æŒ‡ç¤ºã«å¾“ã£ã¦ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            æ—¥æœ¬èªã§å¿œç­”ã—ã€å¿…è¦æœ€å°é™ã®æ“ä½œã§åŠ¹ç‡çš„ã«ä½œæ¥­ã—ã¦ãã ã•ã„ã€‚

  # CodeRabbitãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸ã®å¿œç­”ï¼ˆè»½é‡ç‰ˆï¼‰
  coderabbit_feedback:
    if: |
      github.event_name == 'pull_request_review' && 
      github.event.review.user.login == 'coderabbitai[bot]' && 
      (contains(github.event.review.body, '**Suggestion:**') || contains(github.event.review.body, '**ææ¡ˆ:**'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write

    steps:
      # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆä¸è¦ - ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã®ã¿
      - name: Analyze CodeRabbit Review
        uses: actions/github-script@v7
        with:
          script: |
            const reviewBody = `${{ github.event.review.body }}`;
            const prNumber = ${{ github.event.pull_request.number }};
            
            // ç°¡å˜ãªåˆ†æã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ï¼ˆClaudeã‚’ä½¿ã‚ãšã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
            const comment = `## CodeRabbitãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æ

            CodeRabbitã‹ã‚‰ä»¥ä¸‹ã®ææ¡ˆãŒã‚ã‚Šã¾ã—ãŸï¼š

            ${reviewBody.substring(0, 500)}...

            é–‹ç™ºè€…ã®çš†æ§˜ã€ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚è©³ç´°ãªåˆ†æãŒå¿…è¦ãªå ´åˆã¯ @claude ã¨ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‚`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

  # ç®¡ç†è€…ç”¨ãƒ„ãƒ¼ãƒ«
  admin_tools:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: github.event.inputs.action_type != 'quality_check'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        if: github.event.inputs.action_type != 'quality_check'
        run: npm ci --prefer-offline --no-audit

      - name: Quality Check Only
        if: github.event.inputs.action_type == 'quality_check'
        run: |
          echo "=== è»½é‡å“è³ªãƒã‚§ãƒƒã‚¯ ==="
          echo "ğŸ” åŸºæœ¬çš„ãªãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ãƒã‚§ãƒƒã‚¯"
          ls -la src/ || echo "âŒ srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "ğŸ” package.jsonã®å­˜åœ¨ç¢ºèª"
          test -f package.json && echo "âœ… package.jsonå­˜åœ¨" || echo "âŒ package.jsonä¸åœ¨"
          echo "ğŸ” TypeScriptè¨­å®šç¢ºèª"
          test -f tsconfig.json && echo "âœ… tsconfig.jsonå­˜åœ¨" || echo "âŒ tsconfig.jsonä¸åœ¨"

      - name: Claude Autofix
        if: github.event.inputs.action_type == 'autofix'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          timeout_minutes: "10"
          allowed_tools: "Edit,View,Bash(npm test)"
          custom_instructions: |
            ç®¡ç†è€…ã‹ã‚‰ã®è‡ªå‹•ä¿®æ­£ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™ã€‚
            ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å“è³ªå•é¡Œã‚’ç‰¹å®šã—ã€ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
            ä¿®æ­£å¾Œã¯å¿…ãšãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦å‹•ä½œç¢ºèªã—ã¦ãã ã•ã„ã€‚ 