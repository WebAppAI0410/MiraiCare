name: Project Health Check

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: {}

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Check for security vulnerabilities
        id: security-check
        run: |
          npm audit --audit-level=moderate 2>&1 | tee security-output.txt || echo "Security issues found"
          echo "security_issues=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check for outdated dependencies
        id: outdated-check
        run: |
          npm outdated 2>&1 | tee outdated-output.txt || echo "Outdated packages found"
          echo "outdated_packages=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check bundle size
        id: bundle-check
        run: |
          npm ci || npm install
          npx expo export --platform web 2>&1 | tee bundle-output.txt || echo "Bundle check failed"
          echo "bundle_failed=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check for TODO/FIXME comments
        id: todo-check
        run: |
          find src -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) -exec grep -Hn "TODO\|FIXME\|HACK\|XXX" {} \; > todo-output.txt || echo "No TODOs found"
          echo "todo_count=$(wc -l < todo-output.txt)" >> $GITHUB_OUTPUT

      - name: Create health report issue
        if: steps.security-check.outputs.security_issues != '0' || steps.outdated-check.outputs.outdated_packages != '0' || steps.todo-check.outputs.todo_count > '10'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let securityIssues = '';
            let outdatedPackages = '';
            let todoComments = '';
            
            try {
              securityIssues = fs.readFileSync('security-output.txt', 'utf8');
            } catch (e) {}
            
            try {
              outdatedPackages = fs.readFileSync('outdated-output.txt', 'utf8');
            } catch (e) {}
            
            try {
              todoComments = fs.readFileSync('todo-output.txt', 'utf8');
            } catch (e) {}

            const todoCount = todoComments.split('\n').filter(line => line.trim()).length;
            
            // Determine priority based on issues
            let claudeModel = '[haiku]';
            let priority = 'low';
            
            if (securityIssues.includes('high') || securityIssues.includes('critical')) {
              claudeModel = '[opus]';
              priority = 'high';
            } else if (securityIssues.includes('moderate') || todoCount > 20) {
              claudeModel = '[sonnet]';
              priority = 'medium';
            }

            const issueBody = `@claude ${claudeModel}

            ## ğŸ¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆ

            å®šæœŸå¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚

            ### ğŸ“Š æ¦‚è¦
            - å„ªå…ˆåº¦: **${priority}**
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ: ${securityIssues.includes('vulnerabilities') ? 'æ¤œå‡º' : 'ãªã—'}
            - å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: ${outdatedPackages.includes('Package') ? 'æ¤œå‡º' : 'ãªã—'}
            - TODO/FIXME: ${todoCount}å€‹

            ${securityIssues ? `### ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ
            \`\`\`
            ${securityIssues.slice(0, 1500)}
            \`\`\`
            ` : ''}

            ${outdatedPackages ? `### ğŸ“¦ å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
            \`\`\`
            ${outdatedPackages.slice(0, 1500)}
            \`\`\`
            ` : ''}

            ${todoCount > 10 ? `### ğŸ“ TODO/FIXME ã‚³ãƒ¡ãƒ³ãƒˆ (${todoCount}å€‹)
            \`\`\`
            ${todoComments.slice(0, 1500)}
            \`\`\`
            ` : ''}

            ### âœ… æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’ä¿®æ­£
            - [ ] é‡è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°
            - [ ] TODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆã‚’æ•´ç†
            - [ ] ä¸è¦ãªã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
            - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°

            ### ğŸ”– åˆ¶ç´„
            - ç ´å£Šçš„å¤‰æ›´ã‚’é¿ã‘ã‚‹
            - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¶­æŒ
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ã†
            `;

            // Check for existing health check issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check'
            });

            if (existingIssues.data.length === 0) {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[health] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆ - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody,
                labels: ['health-check', 'maintenance', priority]
              });

              console.log(`Created health check issue #${issue.data.number}`);
            } 