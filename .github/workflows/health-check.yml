name: Project Health Check

on:
  schedule:
    - cron: '0 9 * * *'  # æ¯æ—¥9æ™‚ã«å®Ÿè¡Œ
  workflow_dispatch: {}

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      security-events: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install
        continue-on-error: true

      - name: Security audit
        id: audit
        run: |
          npm audit --audit-level=moderate 2>&1 | tee audit-output.txt || echo "Security issues found"
          echo "audit_issues=$(wc -l < audit-output.txt)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check for outdated packages
        id: outdated
        run: |
          npm outdated 2>&1 | tee outdated-output.txt || echo "Outdated packages found"
          echo "outdated_count=$(wc -l < outdated-output.txt)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Find TODO/FIXME comments
        id: todos
        run: |
          find src -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) -exec grep -Hn "TODO\|FIXME\|XXX\|HACK" {} \; > todos-output.txt || echo "No TODOs found"
          echo "todo_count=$(wc -l < todos-output.txt)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Create health report issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let auditOutput = '';
            let outdatedOutput = '';
            let todosOutput = '';
            
            try {
              auditOutput = fs.readFileSync('audit-output.txt', 'utf8');
            } catch (e) {}
            
            try {
              outdatedOutput = fs.readFileSync('outdated-output.txt', 'utf8');
            } catch (e) {}
            
            try {
              todosOutput = fs.readFileSync('todos-output.txt', 'utf8');
            } catch (e) {}

            const auditIssues = (auditOutput.match(/vulnerabilities/gi) || []).length;
            const outdatedCount = outdatedOutput.split('\n').filter(line => line.trim()).length;
            const todoCount = todosOutput.split('\n').filter(line => line.trim()).length;

            if (auditIssues === 0 && outdatedCount === 0 && todoCount === 0) {
              console.log('No health issues detected');
              return;
            }

            const issueBody = `@claude [haiku]

            ## ğŸ¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆ

            ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

            ### ğŸ“Š æ¦‚è¦
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§: ${auditIssues}å€‹
            - å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: ${outdatedCount}å€‹
            - TODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆ: ${todoCount}å€‹

            ${auditOutput ? `### ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
            \`\`\`
            ${auditOutput.slice(0, 2000)}
            \`\`\`
            ` : ''}

            ${outdatedOutput ? `### ğŸ“¦ å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
            \`\`\`
            ${outdatedOutput.slice(0, 2000)}
            \`\`\`
            ` : ''}

            ${todosOutput ? `### ğŸ“ TODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆ
            \`\`\`
            ${todosOutput.slice(0, 2000)}
            \`\`\`
            ` : ''}

            ### âœ… æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’ä¿®æ­£
            - [ ] å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°
            - [ ] TODO/FIXMEã‚³ãƒ¡ãƒ³ãƒˆã‚’è§£æ±º
            - [ ] ä¾å­˜é–¢ä¿‚ã®æœ€é©åŒ–
            - [ ] ã‚³ãƒ¼ãƒ‰ã®å“è³ªå‘ä¸Š

            ### ğŸ“… æ¬¡å›ãƒã‚§ãƒƒã‚¯
            æ¬¡å›ã®è‡ªå‹•å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ã¯æ˜æ—¥å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
            `;

            // Check if similar issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check'
            });

            const today = new Date().toISOString().split('T')[0];
            const similarIssue = existingIssues.data.find(issue => 
              issue.title.includes('å¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆ') && 
              issue.title.includes(today)
            );

            if (!similarIssue) {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[health] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆ - ${today}`,
                body: issueBody,
                labels: ['health-check', 'maintenance']
              });

              console.log(`Created health report issue #${issue.data.number}`);
            } else {
              console.log(`Health report already exists: #${similarIssue.number}`);
            } 