name: Auto Issue Management

on:
  schedule:
    - cron: '0 */1 * * *'  # æ¯æ™‚å®Ÿè¡Œ
  workflow_dispatch: {}

jobs:
  manage-issues:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read

    steps:
      - uses: actions/checkout@v4

      - name: Check and close resolved issues
        uses: actions/github-script@v7
        with:
          script: |
            // è‡ªå‹•ä½œæˆã•ã‚ŒãŸIssueã‚’å–å¾—
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-detected'
            });

            for (const issue of issues.data) {
              console.log(`Checking issue #${issue.number}: ${issue.title}`);
              
              // Issueã®ä½œæˆã‹ã‚‰24æ™‚é–“ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              const createdAt = new Date(issue.created_at);
              const now = new Date();
              const hoursSinceCreated = (now - createdAt) / (1000 * 60 * 60);
              
              if (hoursSinceCreated > 24) {
                // 24æ™‚é–“ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆã€é€²æ—ç¢ºèªã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number
                });
                
                const hasProgressComment = comments.data.some(comment => 
                  comment.body.includes('é€²æ—ç¢ºèª') || 
                  comment.body.includes('progress check')
                );
                
                if (!hasProgressComment) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: |
                      ## ğŸ• é€²æ—ç¢ºèª

                      ã“ã®Issueã¯24æ™‚é–“ä»¥ä¸Šå‰ã«ä½œæˆã•ã‚Œã¾ã—ãŸãŒã€ã¾ã è§£æ±ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

                      ### ç¾åœ¨ã®çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
                      - [ ] ä¿®æ­£ä½œæ¥­ä¸­
                      - [ ] è¿½åŠ èª¿æŸ»ãŒå¿…è¦
                      - [ ] å¤–éƒ¨ä¾å­˜é–¢ä¿‚å¾…ã¡
                      - [ ] å„ªå…ˆåº¦å¤‰æ›´ãŒå¿…è¦

                      ä¿®æ­£ãŒå®Œäº†ã—ãŸå ´åˆã¯ã€ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚
                      è¿½åŠ ã®ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ãªå ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚

                      ---
                      *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•Issueç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚*
                  });
                  
                  console.log(`Added progress check comment to issue #${issue.number}`);
                }
              }
              
              // ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
              // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€æœ€æ–°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
              const recentRuns = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'auto-error-detection.yml',
                status: 'completed',
                per_page: 5
              });
              
              const latestSuccessfulRun = recentRuns.data.workflow_runs.find(run => 
                run.conclusion === 'success' && 
                new Date(run.created_at) > createdAt
              );
              
              if (latestSuccessfulRun) {
                // æœ€æ–°ã®æˆåŠŸã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒãŒIssueä½œæˆå¾Œã«ã‚ã‚‹å ´åˆ
                // ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ç¢ºèªã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                const hasResolutionComment = comments.data.some(comment => 
                  comment.body.includes('è§£æ±ºç¢ºèª') || 
                  comment.body.includes('resolution check')
                );
                
                if (!hasResolutionComment) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: |
                      ## âœ… è§£æ±ºç¢ºèª

                      æœ€æ–°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒãŒæˆåŠŸã—ã¾ã—ãŸã€‚ã“ã®Issueã§å ±å‘Šã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

                      ### ç¢ºèªäº‹é …ï¼š
                      - [ ] å ±å‘Šã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãŒä¿®æ­£ã•ã‚Œã¦ã„ã‚‹
                      - [ ] ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«é€šéã—ã¦ã„ã‚‹
                      - [ ] é–¢é€£ã™ã‚‹æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹

                      ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚
                      ã¾ã å•é¡ŒãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯ã€è©³ç´°ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚

                      ---
                      *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•Issueç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚*
                  });
                  
                  // è‡ªå‹•è§£æ±ºãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['auto-resolved']
                  });
                  
                  console.log(`Added resolution check comment to issue #${issue.number}`);
                }
              }
            }

      - name: Clean up old resolved issues
        uses: actions/github-script@v7
        with:
          script: |
            // 7æ—¥ä»¥ä¸Šå‰ã«ä½œæˆã•ã‚Œã€auto-resolvedãƒ©ãƒ™ãƒ«ãŒä»˜ã„ã¦ã„ã‚‹Issueã‚’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-resolved'
            });

            for (const issue of issues.data) {
              const createdAt = new Date(issue.created_at);
              const now = new Date();
              const daysSinceCreated = (now - createdAt) / (1000 * 60 * 60 * 24);
              
              if (daysSinceCreated > 7) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: |
                    ## ğŸ”’ è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º

                    ã“ã®Issueã¯7æ—¥ä»¥ä¸Šå‰ã«è§£æ±ºæ¸ˆã¿ã¨ãƒãƒ¼ã‚¯ã•ã‚Œã€è¿½åŠ ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒãªã„ãŸã‚è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚

                    å•é¡ŒãŒå†ç™ºã—ãŸå ´åˆã¯ã€æ–°ã—ã„Issueã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

                    ---
                    *ã“ã®Issueã¯è‡ªå‹•Issueç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚*
                });
                
                console.log(`Auto-closed issue #${issue.number} after 7 days of resolution`);
              }
            } 