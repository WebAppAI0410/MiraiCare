name: Auto Issue Management

on:
  pull_request:
    types: [closed]
  push:
    branches: [main]
  schedule:
    # æ¯æ™‚å®Ÿè¡Œã—ã¦Issueã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    - cron: '0 * * * *'

jobs:
  manage-issues:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Check if errors are resolved
        id: error-check
        run: |
          npm ci || npm install || echo "Install failed"
          
          # Run checks
          npm run lint > /dev/null 2>&1 && echo "lint_passed=true" >> $GITHUB_OUTPUT || echo "lint_passed=false" >> $GITHUB_OUTPUT
          npm test > /dev/null 2>&1 && echo "test_passed=true" >> $GITHUB_OUTPUT || echo "test_passed=false" >> $GITHUB_OUTPUT
          npx tsc --noEmit > /dev/null 2>&1 && echo "tsc_passed=true" >> $GITHUB_OUTPUT || echo "tsc_passed=false" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Auto-close resolved issues
        if: steps.error-check.outputs.lint_passed == 'true' && steps.error-check.outputs.test_passed == 'true' && steps.error-check.outputs.tsc_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Get all open auto-detected issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-detected'
            });

            for (const issue of issues.data) {
              // Close the issue with a comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ‰ **è‡ªå‹•è§£æ±ºç¢ºèª**

                ã“ã®Issueã§å ±å‘Šã•ã‚Œã¦ã„ãŸå•é¡ŒãŒè§£æ±ºã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸï¼š
                - âœ… Lint: åˆæ ¼
                - âœ… Tests: åˆæ ¼  
                - âœ… TypeScript: åˆæ ¼

                è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã€‚

                ---
                *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•Issueç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                labels: [...issue.labels.map(l => l.name), 'auto-resolved']
              });

              console.log(`Auto-closed issue #${issue.number}`);
            }

      - name: Create progress report for open issues
        uses: actions/github-script@v7
        with:
          script: |
            const openIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-detected'
            });

            if (openIssues.data.length > 0) {
              console.log(`Found ${openIssues.data.length} open auto-detected issues`);
              
              for (const issue of openIssues.data) {
                // Check if issue is older than 24 hours
                const issueAge = Date.now() - new Date(issue.created_at).getTime();
                const hoursOld = issueAge / (1000 * 60 * 60);
                
                if (hoursOld > 24) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `â° **é€²æ—ç¢ºèª**

                    ã“ã®Issueã¯${Math.floor(hoursOld)}æ™‚é–“å‰ã«ä½œæˆã•ã‚Œã¾ã—ãŸãŒã€ã¾ã è§£æ±ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

                    ç¾åœ¨ã®çŠ¶æ³ï¼š
                    - Lint: ${process.env.lint_passed === 'true' ? 'âœ… åˆæ ¼' : 'âŒ å¤±æ•—'}
                    - Tests: ${process.env.test_passed === 'true' ? 'âœ… åˆæ ¼' : 'âŒ å¤±æ•—'}
                    - TypeScript: ${process.env.tsc_passed === 'true' ? 'âœ… åˆæ ¼' : 'âŒ å¤±æ•—'}

                    @claude ã‚ˆã‚Šè©³ç´°ãªåˆ†æã¨ä¿®æ­£æ¡ˆã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚`
                  });
                }
              }
            }
        env:
          lint_passed: ${{ steps.error-check.outputs.lint_passed }}
          test_passed: ${{ steps.error-check.outputs.test_passed }}
          tsc_passed: ${{ steps.error-check.outputs.tsc_passed }} 