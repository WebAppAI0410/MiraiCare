---
author: Claude
date: 2025-05-27
title: Phase 4 - リスクスコア計算APIの実装
pr_number: 71
pr_author: WebAppAI0410
---

# Phase 4: リスクスコア計算APIの実装

## 概要

PR #71では、MiraiCare（高齢者向けヘルスケアSaaS）にフェーズ4として包括的なリスクスコア計算APIを実装しました。本実装により、歩数データ、気分データ、アプリ利用状況を総合的に分析し、高齢者の健康リスクを多角的に評価する機能が追加されました。

## 実装内容

### 1. 新規サービスクラスの追加

#### PedometerService (`src/services/pedometerService.ts`)
- **機能**: Expo Pedometer APIとの統合による歩数データ管理
- **主要機能**:
  - リアルタイム歩数監視
  - 週間歩数履歴の取得（7日間）
  - 目標達成率の計算
  - 推定距離・消費カロリーの算出
  - キャッシュ機能による高速データ取得
  - パーミッション管理

#### RiskCalculationService (`src/services/riskCalculationService.ts`)
- **機能**: 包括的な健康リスク評価エンジン
- **リスク評価項目**:
  1. **転倒リスク**: 急激な歩数減少、不規則な活動パターン、低活動レベル、一貫性スコア
  2. **フレイルリスク**: 週平均歩数、月間トレンド、活動日数
  3. **メンタルヘルスリスク**: 気分スコア、アプリ利用頻度
- **総合評価**: 各リスクを統合した包括的評価と推奨アドバイス

### 2. UI/UXの大幅改善

#### ActivityScreen の全面リニューアル
- **変更点**:
  - 歩数中心の画面デザインに刷新
  - 週間グラフによる視覚的な進捗表示
  - リアルタイム歩数更新
  - 目標達成時のお祝いメッセージ
  - エラーハンドリングの強化
- **アクセシビリティ**: 高齢者向けの大きなテキスト、明確な色分け

#### HomeScreen のリスク評価統合
- **新機能**:
  - 自動リスク評価の実行
  - リスクレベル表示
  - 高リスク時のアラート機能
  - リアルタイムでのリスク状態更新

### 3. データ永続化の拡張

#### Firestore統合の強化
- **新API追加**:
  - `saveRiskAssessment()`: リスク評価結果の保存
  - `getLatestRiskAssessment()`: 最新評価の高速取得
  - `getUserSettings()`: ユーザー設定の管理
  - `updateUserSettings()`: 設定の更新
- **データ構造**: TypeScript型定義による厳密なデータ管理

### 4. 型定義の完全実装

#### 新規型定義 (`src/types/index.ts`)
```typescript
// 歩数データ
interface StepData {
  date: string;
  steps: number;
}

// リスク評価
interface FallRisk {
  level: RiskLevel;
  score: number;
  factors: string[];
  lastUpdated: string;
  indicators: {
    stepDecline: boolean;
    irregularPattern: boolean;
    lowActivity: boolean;
    consistencyScore: number;
  };
}

// 総合リスク評価
interface OverallRiskAssessment {
  userId: string;
  fallRisk: FallRisk;
  frailtyRisk: FrailtyRisk;
  mentalHealthRisk: MentalHealthRisk;
  overallLevel: RiskLevel;
  recommendedActions: string[];
  createdAt: string;
}
```

## 技術的実装詳細

### アルゴリズムの実装

#### 転倒リスク計算
- **急激な歩数減少の検知**: 30%以上の減少を検出
- **不規則パターンの検出**: 変動係数50%以上を基準
- **低活動レベル判定**: 推奨歩数4000歩を基準
- **一貫性スコア**: 活動パターンの安定性を数値化

#### フレイルリスク評価
- **週平均歩数分析**: 月間データの統計解析
- **トレンド分析**: 前半・後半比較による活動変化の検出
- **活動日数評価**: 継続的な活動の維持状況

#### メンタルヘルスリスク
- **気分スコア**: 5段階評価を0-100スケールに変換
- **アプリ利用頻度**: 7日間の利用パターン分析

### パフォーマンス最適化

#### キャッシュ戦略
- 週間履歴データの5分間キャッシュ
- リスク評価結果の永続化による高速表示

#### 非同期処理
- Promise.allによる並列データ取得
- エラーハンドリングの包括的実装

## テスト戦略

### 包括的テストカバレッジ
- **単体テスト**: 新規サービスクラスの詳細テスト
  - `pedometerService.test.ts`: 270行のテストコード
  - `riskCalculationService.test.ts`: 349行のテストコード
- **統合テスト**: UI連携とデータフローのテスト
- **UIテスト**: `ActivityScreen.test.tsx`の新規追加

### テスト結果
- ✅ 全194件のテストが成功
- ✅ TypeScriptコンパイルエラーなし
- ✅ ESLintエラーなし
- ✅ TDDアプローチによる高品質実装

## システムへの影響

### 正の影響
1. **ユーザー体験の向上**:
   - 直感的で見やすい歩数表示
   - リアルタイムな健康状態の把握
   - 個別化された健康アドバイス

2. **医療的価値の向上**:
   - 科学的根拠に基づくリスク評価
   - 早期警告システムによる予防医療の実現
   - データ駆動型の健康管理

3. **技術的品質の向上**:
   - TypeScript型安全性の強化
   - モジュラー設計による保守性向上
   - 包括的テストによる信頼性確保

### パフォーマンスへの影響
- **新規API追加**: 2つの主要サービスクラス
- **データベース負荷**: 効率的なクエリ設計により最小化
- **メモリ使用量**: キャッシュ戦略による最適化

## セキュリティとプライバシー

### プライバシー保護
- 個人の健康データの適切な暗号化
- Firestoreセキュリティルールの遵守
- ユーザー同意に基づくデータ利用

### セキュリティ強化
- 入力データの検証
- エラーハンドリングによる情報漏洩防止
- 最小権限原則の適用

## アクセシビリティ

### 高齢者向け配慮
- 大きなフォントサイズ
- 明確な色分けとコントラスト
- 直感的なアイコンとメッセージ
- 音声フィードバック（将来実装予定）

## 既存機能への影響

### 破壊的変更
- `saveVitalData()`のシグネチャ変更
- ActivityScreenの画面構成変更

### 移行対応
- 既存テストの更新
- モック関数の調整
- 型定義の統合

## 今後の開発への示唆

### Phase 5への準備
- リスク評価データの蓄積
- 機械学習モデルの導入基盤
- より高度な予測アルゴリズムの実装可能性

### 技術債務の解決
- 重複する型定義の統合
- API設計の一貫性向上
- パフォーマンス監視の導入

### 拡張可能性
- 新しいバイタルデータの統合
- 外部医療システムとの連携
- AIによる個別化推奨の強化

## 課題と改善点

### 現在の制限事項
1. **データ履歴**: 現在は7-30日の短期分析
2. **リスク要因**: 歩数・気分中心（他のバイタルデータ未統合）
3. **個別化**: 年齢・性別・既往歴の考慮が限定的

### 将来の改善計画
1. **長期トレンド分析**: 6ヶ月〜1年のデータ分析
2. **多次元リスク評価**: 血圧、心拍数等の統合
3. **パーソナライゼーション**: 個人特性を考慮したアルゴリズム

## 結論

Phase 4の実装により、MiraiCareは単なる歩数計アプリから包括的な健康リスク評価プラットフォームへと進化しました。科学的根拠に基づくリスク計算、直感的なUI/UX、堅牢なテスト戦略により、高齢者の健康管理に真の価値を提供する基盤が整いました。

今回の実装は、技術的負債を解決しつつ新機能を追加する模範的な例であり、TDDアプローチとTypeScript型安全性により高い品質を実現しています。Phase 5以降の発展に向けた強固な基盤が構築されました。

---
*Generated with [Claude Code](https://claude.ai/code)*